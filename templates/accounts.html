{% extends "base.html" %}

{% block title %}Accounts - FB Auto Poster{% endblock %}

{% block body %}
<div class="dashboard">
    <nav class="sidebar">
        <div class="sidebar-header">
            <svg class="logo-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
            <span>FB Auto Poster</span>
        </div>
        
        <button class="mobile-menu-toggle" onclick="toggleSidebar()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="/dashboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a href="/groups">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Manage Groups
                </a>
            </li>
            <li class="nav-item">
                <a href="/post">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Create Post
                </a>
            </li>
            <li class="nav-item">
                <a href="/templates">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                    </svg>
                    Templates
                </a>
            </li>
            <li class="nav-item">
                <a href="/media">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    Media Library
                </a>
            </li>
            <li class="nav-item active">
                <a href="/accounts">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    Accounts
                </a>
            </li>
            <li class="nav-item">
                <a href="/analytics">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                    Analytics
                </a>
            </li>
            <li class="nav-item">
                <a href="/history">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                        <polyline points="17 6 23 6 23 12"></polyline>
                    </svg>
                    Post History
                </a>
            </li>
        </ul>
        
        <div class="sidebar-footer">
            <a href="/logout" class="btn-logout">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Logout
            </a>
        </div>
    </nav>
    
    <main class="main-content">
        <header class="content-header">
            <h2>Facebook Accounts</h2>
            <button class="btn btn-primary" onclick="showAddAccountModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="8.5" cy="7" r="4"></circle>
                    <line x1="20" y1="8" x2="20" y2="14"></line>
                    <line x1="23" y1="11" x2="17" y2="11"></line>
                </svg>
                Add Account
            </button>
        </header>
        
        <div class="info-banner">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <div>
                <strong>Multi-Account Support</strong>
                <p>Manage multiple Facebook accounts and switch between them for posting. Each account has its own session and groups.</p>
            </div>
        </div>
        
        <div class="dashboard-section">
            <div class="section-header">
                <h3>Your Accounts</h3>
            </div>
            <div id="accountsList" class="accounts-grid">
                <div class="loading">Loading accounts...</div>
            </div>
        </div>

        <div class="dashboard-section">
            <div class="section-header">
                <h3>Session Backups</h3>
                <button class="btn btn-sm btn-secondary" onclick="createBackup()">Create Backup</button>
            </div>
            <div id="backupsList" class="backups-list">
                <div class="loading">Loading backups...</div>
            </div>
        </div>
    </main>
</div>

<!-- Add Account Modal -->
<div id="addAccountModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Facebook Account</h3>
            <button class="btn-close" onclick="closeAddAccountModal()">&times;</button>
        </div>
        <form id="addAccountForm">
            <div class="form-group">
                <label for="accountName">Account Name *</label>
                <input type="text" id="accountName" required placeholder="e.g., Business Account">
            </div>
            <div class="form-group">
                <label for="accountEmail">Email (optional)</label>
                <input type="email" id="accountEmail" placeholder="email@example.com">
                <span class="form-help">For reference only - won't be used for login</span>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddAccountModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Account</button>
            </div>
        </form>
    </div>
</div>

<!-- Login Modal -->
<div id="loginModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Login to Account</h3>
            <button class="btn-close" onclick="closeLoginModal()">&times;</button>
        </div>
        <div class="login-options">
            <p>Choose how to login to this Facebook account:</p>
            <div class="login-option-cards">
                <div class="login-option" onclick="startManualLogin()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    <h4>Manual Login</h4>
                    <p>Open browser and login yourself (recommended)</p>
                </div>
                <div class="login-option" onclick="showAutoLogin()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                        <polyline points="10 17 15 12 10 7"></polyline>
                        <line x1="15" y1="12" x2="3" y2="12"></line>
                    </svg>
                    <h4>Auto Login</h4>
                    <p>Enter credentials for automatic login</p>
                </div>
            </div>
            <div id="autoLoginForm" style="display:none; margin-top:20px;">
                <div class="form-group">
                    <label for="loginEmail">Email/Phone</label>
                    <input type="text" id="loginEmail" placeholder="Enter Facebook email or phone">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password">
                </div>
                <button class="btn btn-primary btn-block" onclick="performAutoLogin()">Login</button>
            </div>
        </div>
    </div>
</div>

<script>
let accounts = [];
let backups = [];
let currentAccountId = null;
let loginAccountId = null;

async function loadAccounts() {
    try {
        const res = await fetch('/api/accounts');
        const data = await res.json();
        const list = document.getElementById('accountsList');
        
        if (!data.success) {
            list.innerHTML = `
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:48px;height:48px;margin-bottom:16px;opacity:0.5;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <h3>Multi-account not enabled</h3>
                    <p>Enable ENABLE_MULTI_ACCOUNT in your .env file</p>
                </div>
            `;
            return;
        }
        
        accounts = data.accounts || [];
        currentAccountId = data.current;
        renderAccounts();
    } catch (e) {
        document.getElementById('accountsList').innerHTML = '<div class="error">Failed to load accounts</div>';
    }
}

function renderAccounts() {
    const list = document.getElementById('accountsList');
    
    if (accounts.length === 0) {
        list.innerHTML = `
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:48px;height:48px;margin-bottom:16px;opacity:0.5;">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <h3>No accounts added</h3>
                <p>Add a Facebook account to start posting</p>
                <button class="btn btn-primary" onclick="showAddAccountModal()">Add First Account</button>
            </div>
        `;
        return;
    }
    
    list.innerHTML = accounts.map(acc => `
        <div class="account-card ${acc.id === currentAccountId ? 'active' : ''}">
            <div class="account-avatar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </div>
            <div class="account-info">
                <h4>${escapeHtml(acc.name)}</h4>
                ${acc.email ? `<span class="account-email">${escapeHtml(acc.email)}</span>` : ''}
                <div class="account-status">
                    ${acc.has_session 
                        ? `<span class="badge badge-success">Session Active</span>`
                        : `<span class="badge badge-warning">No Session</span>`
                    }
                    ${acc.id === currentAccountId ? `<span class="badge badge-info">Current</span>` : ''}
                </div>
            </div>
            <div class="account-actions">
                ${acc.id !== currentAccountId 
                    ? `<button class="btn btn-sm btn-primary" onclick="switchAccount('${acc.id}')">Switch</button>`
                    : ''
                }
                ${!acc.has_session 
                    ? `<button class="btn btn-sm btn-secondary" onclick="loginToAccount('${acc.id}')">Login</button>`
                    : ''
                }
                <button class="btn btn-sm btn-danger" onclick="deleteAccount('${acc.id}')">Delete</button>
            </div>
        </div>
    `).join('');
}

async function loadBackups() {
    try {
        const res = await fetch('/api/backups');
        const data = await res.json();
        const list = document.getElementById('backupsList');
        
        if (!data.success) {
            list.innerHTML = '<div class="empty-state"><p>Backups not available</p></div>';
            return;
        }
        
        backups = data.backups || [];
        
        if (backups.length === 0) {
            list.innerHTML = '<div class="empty-state"><p>No backups yet. Create a backup to save your sessions.</p></div>';
            return;
        }
        
        list.innerHTML = backups.map(b => `
            <div class="backup-item">
                <div class="backup-info">
                    <span class="backup-name">${escapeHtml(b.name || b)}</span>
                    <span class="backup-date">${b.created_at ? new Date(b.created_at).toLocaleString() : ''}</span>
                </div>
                <div class="backup-actions">
                    <button class="btn btn-sm btn-secondary" onclick="restoreBackup('${escapeHtml(b.name || b)}')">Restore</button>
                </div>
            </div>
        `).join('');
    } catch (e) {
        document.getElementById('backupsList').innerHTML = '<div class="error">Failed to load backups</div>';
    }
}

function showAddAccountModal() {
    document.getElementById('addAccountForm').reset();
    document.getElementById('addAccountModal').classList.add('active');
}

function closeAddAccountModal() {
    document.getElementById('addAccountModal').classList.remove('active');
}

document.getElementById('addAccountForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    try {
        const res = await fbAutoPoster.csrfFetch('/api/accounts', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: document.getElementById('accountName').value,
                email: document.getElementById('accountEmail').value
            })
        });
        
        const data = await res.json();
        
        if (data.success) {
            fbAutoPoster.showNotification('Account added!', 'success');
            closeAddAccountModal();
            loadAccounts();
        } else {
            fbAutoPoster.showNotification('Failed: ' + data.error, 'error');
        }
    } catch (e) {
        fbAutoPoster.showNotification('Error adding account', 'error');
    }
});

async function switchAccount(id) {
    try {
        const res = await fbAutoPoster.csrfFetch(`/api/accounts/${id}/switch`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            fbAutoPoster.showNotification('Switched account!', 'success');
            loadAccounts();
        } else {
            fbAutoPoster.showNotification('Failed to switch: ' + data.error, 'error');
        }
    } catch (e) {
        fbAutoPoster.showNotification('Error switching account', 'error');
    }
}

async function deleteAccount(id) {
    if (!confirm('Delete this account? This will also delete its session.')) return;
    
    try {
        const res = await fbAutoPoster.csrfFetch(`/api/accounts/${id}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (data.success) {
            fbAutoPoster.showNotification('Account deleted', 'success');
            loadAccounts();
        }
    } catch (e) {
        fbAutoPoster.showNotification('Error deleting account', 'error');
    }
}

function loginToAccount(id) {
    loginAccountId = id;
    document.getElementById('autoLoginForm').style.display = 'none';
    document.getElementById('loginModal').classList.add('active');
}

function closeLoginModal() {
    document.getElementById('loginModal').classList.remove('active');
    loginAccountId = null;
}

async function startManualLogin() {
    closeLoginModal();
    try {
        const res = await fbAutoPoster.csrfFetch('/api/fb-manual-login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ account_id: loginAccountId })
        });
        
        const data = await res.json();
        
        if (data.success) {
            fbAutoPoster.showNotification('Browser opening - please login', 'success');
        }
    } catch (e) {
        fbAutoPoster.showNotification('Error starting login', 'error');
    }
}

function showAutoLogin() {
    document.getElementById('autoLoginForm').style.display = 'block';
}

async function performAutoLogin() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        fbAutoPoster.showNotification('Please enter email and password', 'error');
        return;
    }
    
    try {
        const res = await fbAutoPoster.csrfFetch('/api/fb-auto-login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email, password, account_id: loginAccountId })
        });
        
        const data = await res.json();
        
        if (data.success) {
            fbAutoPoster.showNotification('Login successful!', 'success');
            closeLoginModal();
            loadAccounts();
        } else {
            fbAutoPoster.showNotification('Login failed: ' + data.error, 'error');
        }
    } catch (e) {
        fbAutoPoster.showNotification('Error during login', 'error');
    }
}

async function createBackup() {
    try {
        const res = await fbAutoPoster.csrfFetch('/api/backups', { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            fbAutoPoster.showNotification('Backup created: ' + data.name, 'success');
            loadBackups();
        } else {
            fbAutoPoster.showNotification('Failed: ' + data.error, 'error');
        }
    } catch (e) {
        fbAutoPoster.showNotification('Error creating backup', 'error');
    }
}

async function restoreBackup(name) {
    if (!confirm('Restore this backup? This will overwrite current sessions.')) return;
    
    try {
        const res = await fbAutoPoster.csrfFetch(`/api/backups/${encodeURIComponent(name)}/restore`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            fbAutoPoster.showNotification('Backup restored!', 'success');
            loadAccounts();
        } else {
            fbAutoPoster.showNotification('Restore failed: ' + data.error, 'error');
        }
    } catch (e) {
        fbAutoPoster.showNotification('Error restoring backup', 'error');
    }
}

function escapeHtml(text) {
    const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#039;' };
    return String(text || '').replace(/[&<>"']/g, m => map[m]);
}

// Initialize
loadAccounts();
loadBackups();
</script>
{% endblock %}
