{% extends "base.html" %}

{% block title %}Analytics - FB Auto Poster{% endblock %}

{% block body %}
<div class="dashboard">
    <nav class="sidebar">
        <div class="sidebar-header">
            <svg class="logo-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
            <span>FB Auto Poster</span>
        </div>
        
        <button class="mobile-menu-toggle" onclick="toggleSidebar()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="/dashboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a href="/groups">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Manage Groups
                </a>
            </li>
            <li class="nav-item">
                <a href="/post">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Create Post
                </a>
            </li>
            <!-- Hidden: Templates, Media Library, Analytics -->
            <li class="nav-item">
                <a href="/accounts">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    Accounts
                </a>
            </li>
            <li class="nav-item">
                <a href="/history">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                        <polyline points="17 6 23 6 23 12"></polyline>
                    </svg>
                    Post History
                </a>
            </li>
        </ul>
        
        <div class="sidebar-footer">
            <a href="/logout" class="btn-logout">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Logout
            </a>
        </div>
    </nav>
    
    <main class="main-content">
        <header class="content-header">
            <h2>Analytics Dashboard</h2>
            <div class="header-actions">
                <select id="dateRange" onchange="loadAllAnalytics()">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                </select>
                <button class="btn btn-secondary" onclick="exportData()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Export CSV
                </button>
            </div>
        </header>
        
        <!-- Overview Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: #e3f2fd;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#1976d2" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3 id="totalPosts">0</h3>
                    <p>Total Posts</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: #e8f5e9;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#388e3c" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3 id="successRate">0%</h3>
                    <p>Success Rate</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: #fff3e0;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#f57c00" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3 id="totalGroups">0</h3>
                    <p>Groups Posted</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: #fce4ec;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#c2185b" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3 id="avgDuration">0s</h3>
                    <p>Avg. Duration</p>
                </div>
            </div>
        </div>
        
        <!-- Charts Row 1 -->
        <div class="charts-grid">
            <div class="chart-card large">
                <div class="chart-header">
                    <h3>Posts Over Time</h3>
                </div>
                <canvas id="postsOverTimeChart" height="300"></canvas>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Success vs Failed</h3>
                </div>
                <canvas id="successFailChart" height="250"></canvas>
            </div>
        </div>
        
        <!-- Charts Row 2 -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Hourly Distribution</h3>
                </div>
                <canvas id="hourlyChart" height="250"></canvas>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Best Posting Times</h3>
                </div>
                <div id="bestTimesList" class="best-times-grid"></div>
            </div>
        </div>
        
        <!-- Group Performance -->
        <div class="dashboard-section">
            <div class="section-header">
                <h3>Group Performance</h3>
            </div>
            <div id="groupPerformance" class="group-performance-grid">
                <div class="loading">Loading group data...</div>
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="dashboard-section">
            <div class="section-header">
                <h3>Recent Activity</h3>
            </div>
            <div id="recentActivity" class="activity-list">
                <div class="loading">Loading activity...</div>
            </div>
        </div>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let charts = {};

async function loadAllAnalytics() {
    const days = parseInt(document.getElementById('dateRange').value);
    
    await Promise.all([
        loadOverviewStats(),
        loadDailyStats(days),
        loadHourlyStats(days),
        loadGroupPerformance(),
        loadBestTimes(),
        loadRecentActivity()
    ]);
}

async function loadOverviewStats() {
    try {
        const res = await fetch('/api/analytics');
        const data = await res.json();
        
        if (!data.success) return;
        
        document.getElementById('totalPosts').textContent = data.total_posts || 0;
        
        const statusCounts = data.status_counts || {};
        const total = (statusCounts.posted || 0) + (statusCounts.failed || 0);
        const successRate = total > 0 ? Math.round((statusCounts.posted / total) * 100) : 0;
        document.getElementById('successRate').textContent = successRate + '%';
        
        // Count unique groups from top_groups
        const topGroups = data.top_groups || [];
        document.getElementById('totalGroups').textContent = topGroups.length;
        
        // Calculate average duration (placeholder)
        document.getElementById('avgDuration').textContent = (data.avg_duration || 0).toFixed(1) + 's';
        
        // Update success/fail chart
        updateSuccessFailChart(statusCounts.posted || 0, statusCounts.failed || 0);
        
    } catch (e) {
        console.error('Error loading overview stats:', e);
    }
}

async function loadDailyStats(days) {
    try {
        const res = await fetch(`/api/analytics/daily?days=${days}`);
        const data = await res.json();
        
        if (!data.success) return;
        
        const stats = data.stats || [];
        updatePostsOverTimeChart(stats);
        
    } catch (e) {
        console.error('Error loading daily stats:', e);
    }
}

async function loadHourlyStats(days) {
    try {
        const res = await fetch(`/api/analytics/hourly?days=${days}`);
        const data = await res.json();
        
        if (!data.success) return;
        
        const stats = data.stats || [];
        updateHourlyChart(stats);
        
    } catch (e) {
        console.error('Error loading hourly stats:', e);
    }
}

async function loadGroupPerformance() {
    try {
        const res = await fetch('/api/analytics/groups');
        const data = await res.json();
        const container = document.getElementById('groupPerformance');
        
        if (!data.success) {
            container.innerHTML = '<p class="text-muted">Analytics not available</p>';
            return;
        }
        
        const groups = data.groups || [];
        
        if (groups.length === 0) {
            container.innerHTML = '<p class="text-muted">No group data yet. Start posting to see performance.</p>';
            return;
        }
        
        container.innerHTML = groups.slice(0, 10).map((g, i) => `
            <div class="group-perf-card">
                <div class="group-rank">#${i + 1}</div>
                <div class="group-info">
                    <h4>${escapeHtml(g.group_name || g.group_id)}</h4>
                    <div class="group-stats">
                        <span class="stat">${g.total_posts || 0} posts</span>
                        <span class="stat success">${g.successful || 0} success</span>
                        <span class="stat failed">${g.failed || 0} failed</span>
                    </div>
                </div>
                <div class="group-rate">
                    <div class="rate-circle" style="--rate: ${Math.round((g.success_rate || 0) * 100)}%">
                        ${Math.round((g.success_rate || 0) * 100)}%
                    </div>
                </div>
            </div>
        `).join('');
        
    } catch (e) {
        console.error('Error loading group performance:', e);
    }
}

async function loadBestTimes() {
    try {
        const res = await fetch('/api/analytics/best-times');
        const data = await res.json();
        const container = document.getElementById('bestTimesList');
        
        if (!data.success || !data.best_times || data.best_times.length === 0) {
            container.innerHTML = '<p class="text-muted">Post more to see optimal times</p>';
            return;
        }
        
        container.innerHTML = data.best_times.slice(0, 6).map(t => `
            <div class="best-time-card">
                <div class="time-hour">${t.hour}:00</div>
                <div class="time-info">
                    <div class="time-bar" style="width: ${Math.round(t.success_rate * 100)}%"></div>
                    <span>${Math.round(t.success_rate * 100)}% success</span>
                </div>
            </div>
        `).join('');
        
    } catch (e) {
        console.error('Error loading best times:', e);
    }
}

async function loadRecentActivity() {
    try {
        const res = await fetch('/api/history');
        const data = await res.json();
        const container = document.getElementById('recentActivity');
        
        if (!data.success) {
            container.innerHTML = '<p class="text-muted">Could not load activity</p>';
            return;
        }
        
        const posts = data.posts || [];
        
        if (posts.length === 0) {
            container.innerHTML = '<p class="text-muted">No posting activity yet</p>';
            return;
        }
        
        container.innerHTML = posts.slice(0, 10).map(p => `
            <div class="activity-item">
                <div class="activity-status ${p.status}">
                    ${p.status === 'posted' 
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>'
                        : p.status === 'failed'
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>'
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>'
                    }
                </div>
                <div class="activity-content">
                    <p class="activity-text">${escapeHtml(p.content).slice(0, 100)}${p.content.length > 100 ? '...' : ''}</p>
                    <span class="activity-meta">${new Date(p.timestamp).toLocaleString()} â€¢ ${(p.groups || []).length} groups</span>
                </div>
            </div>
        `).join('');
        
    } catch (e) {
        console.error('Error loading activity:', e);
    }
}

function updatePostsOverTimeChart(stats) {
    const ctx = document.getElementById('postsOverTimeChart');
    
    if (charts.postsOverTime) {
        charts.postsOverTime.destroy();
    }
    
    charts.postsOverTime = new Chart(ctx, {
        type: 'line',
        data: {
            labels: stats.map(s => s.date),
            datasets: [{
                label: 'Posts',
                data: stats.map(s => s.total || s.count || 0),
                borderColor: '#1976d2',
                backgroundColor: 'rgba(25, 118, 210, 0.1)',
                fill: true,
                tension: 0.4
            }, {
                label: 'Successful',
                data: stats.map(s => s.successful || 0),
                borderColor: '#388e3c',
                backgroundColor: 'transparent',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function updateSuccessFailChart(success, failed) {
    const ctx = document.getElementById('successFailChart');
    
    if (charts.successFail) {
        charts.successFail.destroy();
    }
    
    charts.successFail = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Successful', 'Failed'],
            datasets: [{
                data: [success, failed],
                backgroundColor: ['#388e3c', '#d32f2f']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

function updateHourlyChart(stats) {
    const ctx = document.getElementById('hourlyChart');
    
    if (charts.hourly) {
        charts.hourly.destroy();
    }
    
    // Fill in missing hours
    const hourlyData = new Array(24).fill(0);
    stats.forEach(s => {
        if (s.hour >= 0 && s.hour < 24) {
            hourlyData[s.hour] = s.count || 0;
        }
    });
    
    charts.hourly = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
            datasets: [{
                label: 'Posts',
                data: hourlyData,
                backgroundColor: '#1976d2',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function exportData() {
    const days = document.getElementById('dateRange').value;
    window.location.href = `/api/analytics/export?days=${days}`;
}

function escapeHtml(text) {
    const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#039;' };
    return String(text || '').replace(/[&<>"']/g, m => map[m]);
}

// Initialize
loadAllAnalytics();
</script>
{% endblock %}
