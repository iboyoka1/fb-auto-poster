{% extends "base.html" %}

{% block title %}Tableau de Bord - {{ app_name|default('FB Auto Poster') }}{% endblock %}

{% block body %}
<div class="dashboard">
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()" aria-label="Toggle menu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>
    
    <!-- Sidebar Overlay (for mobile) -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <nav class="sidebar">
        <div class="sidebar-header">
            <svg class="logo-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
            <span>{{ app_name|default('FB Auto Poster') }}</span>
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item active">
                <a href="/dashboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Tableau de Bord
                </a>
            </li>
            <li class="nav-item">
                <a href="/groups">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    G√©rer les Groupes
                </a>
            </li>
            <li class="nav-item">
                <a href="/post">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Cr√©er une Publication
                </a>
            </li>
            <li class="nav-item">
                <a href="/history">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                        <polyline points="17 6 23 6 23 12"></polyline>
                    </svg>
                    Historique
                </a>
            </li>
            <!-- Hidden: Templates, Media Library, Analytics -->
            <li class="nav-item">
                <a href="/accounts">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    Comptes
                </a>
            </li>
            <li class="nav-item">
                <a href="/manual-login">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    Connexion Manuelle
                </a>
            </li>
            <li class="nav-item">
                <a href="/settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    Param√®tres
                </a>
            </li>
        </ul>
        
        <div class="sidebar-footer">
            <a href="/logout" class="btn-logout">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                D√©connexion
            </a>
        </div>
    </nav>
    
    <main class="main-content">
        <header class="content-header">
            <h2>Vue d'ensemble</h2>
            <span class="badge badge-primary">En ligne</span>
        </header>
        
        <!-- Facebook Session Status Card -->
        <div id="fbSessionCard" class="session-card" style="display: none; margin-bottom: 24px; padding: 20px 24px; border-radius: 16px; border-left: 5px solid; background: linear-gradient(135deg, #f0f7ff 0%, #e8f4fd 100%); box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
            <div style="display: flex; align-items: center; gap: 18px;">
                <div id="sessionIcon" style="font-size: 36px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">‚ö†Ô∏è</div>
                <div style="flex: 1;">
                    <h3 id="sessionTitle" style="margin: 0 0 6px 0; font-size: 17px; font-weight: 700; color: #1a1a2e;">Statut de la Session Facebook</h3>
                    <p id="sessionMessage" style="margin: 0; color: #5a5a7a; font-size: 14px; line-height: 1.5;"></p>
                </div>
                <button id="sessionActionBtn" type="button" class="btn btn-primary" style="display: none;"></button>
            </div>
        </div>
        
        <!-- Quick Setup Section -->
        <div class="quick-setup-card" id="quickSetupSection" style="display:none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: white;">Guide de D√©marrage Rapide</h3>
                <button onclick="dismissQuickSetup()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Fermer</button>
            </div>
            <div class="setup-steps" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                <div class="step" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 10px;">1</div>
                    <p style="margin: 0; font-weight: 500;">D√©couvrir les Groupes</p>
                    <a href="/groups" style="color: white; text-decoration: underline; font-size: 13px;">Aller aux Groupes</a>
                </div>
                <div class="step" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 10px;">2</div>
                    <p style="margin: 0; font-weight: 500;">Cr√©er du Contenu</p>
                    <a href="/post" style="color: white; text-decoration: underline; font-size: 13px;">Cr√©er une Publication</a>
                </div>
                <div class="step" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 10px;">3</div>
                    <p style="margin: 0; font-weight: 500;">Commencer √† Publier</p>
                    <a href="/post" style="color: white; text-decoration: underline; font-size: 13px;">Cr√©er une Publication</a>
                </div>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(79, 70, 229, 0.15) 100%);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3 id="totalGroups">0</h3>
                    <p>Total Groupes</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3 id="sessionStatus">‚úì</h3>
                    <p>Session FB</p>
                </div>
            </div>
            <div class="stat-card" id="postingIndicatorCard" style="display:none;">
                <div class="stat-icon" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(79, 70, 229, 0.15) 100%);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 6v6l4 2"></path>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3 id="postingCount">0</h3>
                    <p>En cours‚Ä¶</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: #fff3e0;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#f57c00" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3 id="recentPosts">0</h3>
                    <p>Publications R√©centes</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #ede7f6;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#6a1b9a" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </div>
                <div class="stat-content">
                    <h3 id="scheduledCount">0</h3>
                    <p>Planifi√©es</p>
                </div>
            </div>
        </div>
        
        <div class="dashboard-section" style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 2px 12px rgba(0,0,0,0.04); border: 1px solid #e4e6eb;">
            <div class="section-header" style="margin-bottom: 16px;">
                <h3 style="font-size: 18px; font-weight: 700; color: #1a1a2e; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 20px;">üîó</span>
                    Session Facebook
                </h3>
            </div>
            <div class="session-status" id="sessionStatusBox">
                <div class="loading" style="padding: 20px; text-align: center; color: #65676b;">V√©rification de la session...</div>
            </div>
            
            <div class="fb-login-form" id="fbLoginForm" style="display: none; margin-top: 24px; padding: 28px; background: linear-gradient(135deg, #fafbfc 0%, #f0f2f5 100%); border-radius: 16px; border: 1px solid #e4e6eb;">
                <h4 style="margin-top: 0; margin-bottom: 20px; font-size: 18px; font-weight: 700; color: #1a1a2e; display: flex; align-items: center; gap: 10px;">
                    <span style="background: linear-gradient(135deg, #1877f2, #42b72a); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">üîê</span>
                    Connecter Facebook
                </h4>
                
                <!-- Upload Cookies Option (Primary for Cloud) -->
                <div style="padding: 24px; background: white; border-radius: 14px; border: 2px solid #1877f2; box-shadow: 0 4px 20px rgba(24, 119, 242, 0.1);">
                    <h5 style="margin-top: 0; margin-bottom: 12px; color: #1877f2; display: flex; align-items: center; gap: 10px; font-size: 15px; font-weight: 600;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="width: 22px; height: 22px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        Importer vos Cookies Facebook
                    </h5>
                    <p style="color: #65676b; font-size: 13px; margin-bottom: 16px; line-height: 1.5;">
                        Collez le contenu de votre fichier <code style="background: #f0f2f5; padding: 2px 6px; border-radius: 4px; font-size: 12px;">facebook-cookies.json</code>
                    </p>
                    <textarea id="cookiesInput" placeholder='[{"name": "c_user", "value": "...", ...}, ...]' style="width: 100%; height: 100px; margin-bottom: 14px; font-size: 12px; font-family: 'Monaco', 'Consolas', monospace; border-radius: 10px; border: 2px solid #e4e6eb; padding: 14px; resize: vertical; transition: border-color 0.2s, box-shadow 0.2s;" onfocus="this.style.borderColor='#1877f2'; this.style.boxShadow='0 0 0 3px rgba(24,119,242,0.1)'" onblur="this.style.borderColor='#e4e6eb'; this.style.boxShadow='none'"></textarea>
                    <button type="button" class="btn btn-primary" id="uploadCookiesBtn" style="width: 100%; padding: 14px 20px; font-weight: 600; font-size: 15px; border-radius: 10px; background: linear-gradient(135deg, #1877f2, #0d65d9); border: none; display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(24,119,242,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="width: 18px; height: 18px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        Importer les Cookies
                    </button>
                </div>
                
                <!-- Upload Groups -->
                <div style="padding: 24px; background: white; border-radius: 14px; margin-top: 16px; border: 2px solid #e4e6eb; transition: border-color 0.2s;">
                    <h5 style="margin-top: 0; margin-bottom: 12px; color: #1a1a2e; display: flex; align-items: center; gap: 10px; font-size: 15px; font-weight: 600;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2.5" style="width: 22px; height: 22px;">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        Importer vos Groupes
                    </h5>
                    <p style="color: #65676b; font-size: 13px; margin-bottom: 16px; line-height: 1.5;">
                        Collez le contenu de votre fichier <code style="background: #f0f2f5; padding: 2px 6px; border-radius: 4px; font-size: 12px;">groups.json</code>
                    </p>
                    <textarea id="groupsInput" placeholder='[{"name": "Mon Groupe", "username": "123456789", "status": "straight"}, ...]' style="width: 100%; height: 80px; margin-bottom: 14px; font-size: 12px; font-family: 'Monaco', 'Consolas', monospace; border-radius: 10px; border: 2px solid #e4e6eb; padding: 14px; resize: vertical; transition: border-color 0.2s, box-shadow 0.2s;" onfocus="this.style.borderColor='#6366f1'; this.style.boxShadow='0 0 0 3px rgba(99,102,241,0.1)'" onblur="this.style.borderColor='#e4e6eb'; this.style.boxShadow='none'"></textarea>
                    <button type="button" class="btn btn-secondary" id="uploadGroupsBtn" style="width: 100%; padding: 14px 20px; font-weight: 600; font-size: 15px; border-radius: 10px; background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border: none; display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(99,102,241,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="width: 18px; height: 18px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        Importer les Groupes
                    </button>
                </div>
            </div>
        </div>
        
        <div class="dashboard-section" style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 2px 12px rgba(0,0,0,0.04); border: 1px solid #e4e6eb; margin-top: 24px;">
            <div class="section-header" style="margin-bottom: 20px;">
                <h3 style="font-size: 18px; font-weight: 700; color: #1a1a2e; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 20px;">‚ö°</span>
                    Actions Rapides
                </h3>
            </div>
            <div class="quick-actions">
                <a href="/groups" class="action-card">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <h4>G√©rer les Groupes</h4>
                    <p>Ajouter, modifier ou supprimer des groupes Facebook</p>
                </a>
                
                <a href="/post" class="action-card">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    <h4>Cr√©er une Publication</h4>
                    <p>√âcrire et publier dans tous les groupes</p>
                </a>
                
                <a href="/history" class="action-card">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                        <polyline points="17 6 23 6 23 12"></polyline>
                    </svg>
                    <h4>Voir l'Historique</h4>
                    <p>Consulter toutes les publications pr√©c√©dentes</p>
                </a>
            </div>
        </div>

        <div class="dashboard-section" style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 2px 12px rgba(0,0,0,0.04); border: 1px solid #e4e6eb; margin-top: 24px;">
            <div class="section-header" style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="font-size: 18px; font-weight: 700; color: #1a1a2e; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 20px;">üìÖ</span>
                    Publications Planifi√©es
                </h3>
                <a href="/post" class="btn btn-sm" style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; text-decoration: none; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">+ Cr√©er</a>
            </div>
            <div id="scheduleList" class="schedules-list">
                <div class="loading" style="padding: 30px; text-align: center; color: #65676b;">Chargement des planifications...</div>
            </div>
        </div>

        <div class="dashboard-section" id="activePostingSection" style="display:none;">
            <div class="section-header">
                <h3>Publication en Cours</h3>
            </div>
            <div id="activePostingList"></div>
        </div>

        <!-- Analytics Charts Section - HIDDEN
        <div class="dashboard-section" id="analyticsSection" style="display: none;">
            <div class="section-header">
                <h3>üìä Analytics</h3>
                <button class="btn btn-sm btn-secondary" onclick="exportAnalytics()">Export CSV</button>
            </div>
            <div class="analytics-grid">
                <div class="chart-card">
                    <h4>Posts Last 7 Days</h4>
                    <canvas id="dailyChart" height="200"></canvas>
                </div>
                <div class="chart-card">
                    <h4>Success Rate</h4>
                    <canvas id="successChart" height="200"></canvas>
                </div>
                <div class="chart-card">
                    <h4>Top Groups</h4>
                    <div id="topGroupsList" class="top-groups-list"></div>
                </div>
                <div class="chart-card">
                    <h4>Best Posting Times</h4>
                    <div id="bestTimesList" class="best-times-list"></div>
                </div>
            </div>
        </div>
        -->
    </main>
</div>

<script>
// Load saved credentials from localStorage
function loadSavedCredentials() {
    const savedEmail = localStorage.getItem('fb_email');
    const savedPassword = localStorage.getItem('fb_password');
    const rememberMe = localStorage.getItem('fb_remember') === 'true';
    
    if (rememberMe && savedEmail) {
        document.getElementById('fbEmail').value = savedEmail;
        document.getElementById('rememberMe').checked = true;
    }
    if (rememberMe && savedPassword) {
        document.getElementById('fbPassword').value = savedPassword;
    }
}

async function loadDashboardStats() {
    try {
        // Load groups count
        const groupsRes = await fetch('/api/groups');
        const groupsData = await groupsRes.json();
        if (groupsData.success) {
            document.getElementById('totalGroups').textContent = groupsData.groups.length;
        }
        
        // Check session status with expiry info
        const sessionRes = await fetch('/api/session-status');
        const sessionData = await sessionRes.json();
        const statusBox = document.getElementById('sessionStatusBox');
        const statusText = document.getElementById('sessionStatus');
        const sessionCard = document.getElementById('fbSessionCard');
        
        if (sessionData.has_session && sessionData.valid) {
            // Check for expiry warning
            if (sessionData.expires_critical) {
                // Critical - less than 6 hours
                statusBox.innerHTML = `<div class="status-warning" style="background: #fff3e0; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                    <strong>‚ö†Ô∏è Session expire bient√¥t!</strong><br>
                    <span style="font-size: 14px;">Expire dans ${Math.round(sessionData.expires_in_hours)} heures. Importez de nouveaux cookies.</span>
                </div>`;
                statusText.textContent = '‚ö†Ô∏è Expire';
                statusText.parentElement.parentElement.style.background = '#fff3e0';
                sessionCard.style.display = 'block';
                sessionCard.style.borderLeftColor = '#ff9800';
                sessionCard.style.background = '#fff8e1';
                document.getElementById('sessionIcon').textContent = '‚ö†Ô∏è';
                document.getElementById('sessionTitle').textContent = 'Session expire bient√¥t!';
                document.getElementById('sessionMessage').textContent = `Votre session Facebook expire dans ${Math.round(sessionData.expires_in_hours)} heures. Importez de nouveaux cookies pour √©viter une interruption.`;
                document.getElementById('fbLoginForm').style.display = 'block';
            } else if (sessionData.expires_warning) {
                // Warning - less than 24 hours
                statusBox.innerHTML = `<div class="status-warning" style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                    <strong>‚è∞ Session expire dans ${Math.round(sessionData.expires_in_hours)} heures</strong><br>
                    <span style="font-size: 14px;">Pensez √† rafra√Æchir vos cookies bient√¥t.</span>
                </div>`;
                statusText.textContent = '‚è∞ ' + Math.round(sessionData.expires_in_hours) + 'h';
                statusText.parentElement.parentElement.style.background = '#e3f2fd';
                sessionCard.style.display = 'block';
                sessionCard.style.borderLeftColor = '#2196f3';
                sessionCard.style.background = '#e3f2fd';
                document.getElementById('sessionIcon').textContent = '‚è∞';
                document.getElementById('sessionTitle').textContent = 'Session expire dans ' + Math.round(sessionData.expires_in_hours) + ' heures';
                document.getElementById('sessionMessage').textContent = 'Votre session est active mais expirera bient√¥t. Pensez √† importer de nouveaux cookies.';
                document.getElementById('fbLoginForm').style.display = 'none';
            } else {
                // All good
                statusBox.innerHTML = '<div class="status-active" style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">‚úì Session Facebook active et valide</div>';
                statusText.textContent = '‚úì Active';
                statusText.parentElement.parentElement.style.background = '#e8f5e9';
                sessionCard.style.display = 'none';
                document.getElementById('fbLoginForm').style.display = 'none';
            }
        } else if (sessionData.has_session && !sessionData.valid) {
            statusBox.innerHTML = '<div class="status-inactive" style="background: #ffebee; padding: 15px; border-radius: 8px; border-left: 4px solid #f44336;">‚ùå Session expir√©e. Veuillez importer de nouveaux cookies.</div>';
            statusText.textContent = '‚úó Expir√©e';
            statusText.parentElement.parentElement.style.background = '#ffebee';
            document.getElementById('fbLoginForm').style.display = 'block';
            sessionCard.style.display = 'block';
            sessionCard.style.borderLeftColor = '#f44336';
            sessionCard.style.background = '#ffebee';
            document.getElementById('sessionIcon').textContent = '‚ùå';
            document.getElementById('sessionTitle').textContent = 'Session expir√©e';
            document.getElementById('sessionMessage').textContent = 'Votre session Facebook a expir√©. Importez de nouveaux cookies pour continuer √† publier.';
        } else {
            statusBox.innerHTML = '<div class="status-inactive" style="background: #f5f5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #9e9e9e;">‚ö™ Aucune session Facebook. Importez vos cookies ci-dessous.</div>';
            statusText.textContent = '‚úó Inactive';
            statusText.parentElement.parentElement.style.background = '#f5f5f5';
            document.getElementById('fbLoginForm').style.display = 'block';
            sessionCard.style.display = 'none';
        }
        
        // Load recent posts
        const historyRes = await fetch('/api/history');
        const historyData = await historyRes.json();
        if (historyData.success) {
            document.getElementById('recentPosts').textContent = historyData.posts.length;
        }

        // Load scheduled count
        try {
            const schedRes = await fetch('/api/schedule');
            const schedData = await schedRes.json();
            if (schedData.success) {
                document.getElementById('scheduledCount').textContent = (schedData.schedules || []).length;
            }
        } catch (_) {}
    } catch (error) {
        console.error('Failed to load stats:', error);
    }
}

document.getElementById('manualLoginBtn').addEventListener('click', async () => {
    const btn = document.getElementById('manualLoginBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Opening browser...';

    try {
        const response = await fbAutoPoster.csrfFetch('/api/fb-manual-login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ start: true })
        });

        const data = await response.json();

        if (data.success) {
            alert('‚úì Browser is opening!\n\nSteps:\n1. Login to Facebook in the browser\n2. Complete any security checks\n3. Wait until you see your Facebook feed\n4. The browser will save your session automatically');
            btn.innerHTML = '<span class="spinner"></span> Waiting for login...';

            const statusEl = document.getElementById('sessionStatus');
            const poll = setInterval(async () => {
                try {
                    const statusRes = await fetch('/api/session-status');
                    const statusData = await statusRes.json();
                    if (statusEl) {
                        statusEl.textContent = (statusData.has_session && statusData.valid) ? '‚úì Active' : '‚úó Inactive';
                    }
                    if (statusData.has_session && statusData.valid) {
                        clearInterval(poll);
                        alert('‚úì Login successful! Your session has been saved.');
                        window.location.reload();
                    }
                } catch (_) {}
            }, 5000);

            setTimeout(() => {
                clearInterval(poll);
                btn.disabled = false;
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg> Open Browser & Login Manually';
            }, 300000);
        } else {
            alert('Failed to start manual login');
            btn.disabled = false;
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg> Open Browser & Login Manually';
        }
    } catch (error) {
        alert('Error: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg> Open Browser & Login Manually';
    }
});

// Upload Cookies handler
document.getElementById('uploadCookiesBtn').addEventListener('click', async () => {
    const btn = document.getElementById('uploadCookiesBtn');
    const cookiesInput = document.getElementById('cookiesInput').value.trim();
    
    if (!cookiesInput) {
        alert('Please paste your cookies JSON first');
        return;
    }
    
    let cookies;
    try {
        cookies = JSON.parse(cookiesInput);
        if (!Array.isArray(cookies)) {
            throw new Error('Cookies must be an array');
        }
    } catch (e) {
        alert('Invalid JSON format. Please paste the exact content from facebook-cookies.json');
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Uploading...';
    
    try {
        const response = await fetch('/api/upload-cookies', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ cookies: cookies })
        });
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server is restarting. Please wait 1-2 minutes and try again.');
        }
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úì Cookies uploaded successfully!\n\nYour Facebook session is now active.');
            window.location.reload();
        } else {
            alert('Failed to upload cookies: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error uploading cookies: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; margin-right: 5px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg> Upload Cookies';
    }
});

// Upload Groups handler
document.getElementById('uploadGroupsBtn').addEventListener('click', async () => {
    const btn = document.getElementById('uploadGroupsBtn');
    const groupsInput = document.getElementById('groupsInput').value.trim();
    
    if (!groupsInput) {
        alert('Please paste your groups.json content first');
        return;
    }
    
    let groups;
    try {
        groups = JSON.parse(groupsInput);
        if (!Array.isArray(groups)) {
            throw new Error('Groups must be an array');
        }
    } catch (e) {
        alert('Invalid JSON format. Please paste the exact content from groups.json');
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Uploading...';
    
    try {
        const response = await fetch('/api/upload-groups', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ groups: groups })
        });
        
        // Check content type before parsing
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            // Server returned HTML (restart page or login redirect)
            if (response.status === 401 || response.redirected) {
                alert('Session expired. Please refresh the page and log in again.');
                window.location.href = '/login';
                return;
            }
            throw new Error('Server is restarting. Please wait 30 seconds and try again.');
        }
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úì Groups uploaded successfully!\n\n' + data.count + ' groups are now available.');
            window.location.reload();
        } else {
            alert('Failed to upload groups: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        if (error.message.includes('<!DOCTYPE') || error.message.includes('Unexpected token')) {
            alert('Server is restarting or session expired.\n\nPlease wait 30 seconds and refresh the page, then try again.');
        } else {
            alert('Error uploading groups: ' + error.message);
        }
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; margin-right: 5px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg> Upload Groups';
    }
});

document.getElementById('autoLoginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const btn = document.getElementById('autoLoginBtn');
    const email = document.getElementById('fbEmail').value;
    const password = document.getElementById('fbPassword').value;
    const rememberMe = document.getElementById('rememberMe').checked;
    
    if (!email || !password) {
        alert('Please enter both email and password');
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Logging in to Facebook...';
    
    try {
        const response = await fbAutoPoster.csrfFetch('/api/fb-auto-login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Save credentials if remember me is checked
            if (rememberMe) {
                localStorage.setItem('fb_email', email);
                localStorage.setItem('fb_password', password);
                localStorage.setItem('fb_remember', 'true');
            } else {
                localStorage.removeItem('fb_email');
                localStorage.removeItem('fb_password');
                localStorage.removeItem('fb_remember');
            }
            alert('‚úì Successfully logged in to Facebook!\n\nYour session has been saved. You can now post to groups.');
            window.location.reload();
        } else {
            alert('‚úó Login failed: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg> Auto-Login to Facebook';
        }
    } catch (error) {
        alert('Error: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg> Auto-Login to Facebook';
    }
});

loadDashboardStats();
// Poll posting status and update indicator
async function pollPostingStatus() {
    try {
        const res = await fetch('/api/posting-status');
        const data = await res.json();
        const card = document.getElementById('postingIndicatorCard');
        const countEl = document.getElementById('postingCount');
        const listEl = document.getElementById('activePostingList');
        if (data.success && data.is_posting) {
            card.style.display = 'flex';
            countEl.textContent = data.posting_count;
            if (listEl) {
                listEl.innerHTML = (data.active_posts || []).map(p => {
                    const total = Math.max(1, p.total || 1);
                    const completed = Math.min(total, p.completed || 0);
                    const percent = Math.round((completed / total) * 100);
                    const eta = p.eta_ms ? formatEta(p.eta_ms) : '‚Äî';
                    const last = p.last_group ? escapeHtml(p.last_group) : '‚Äî';
                    const groupsBrief = (p.groups || []).map(g => `<span class="group-tag ${g.status==='failed'?'badge-danger':''}">${escapeHtml(g.name || g.username || '')}</span>`).join('');
                    return `
                        <div class="progress-item">
                            <div class="progress-label">Post #${p.post_id} ‚Äî ${percent}% ‚Äî ETA: ${eta} ‚Äî Last: ${last}</div>
                            <div class="progress-bar"><div class="progress-fill" style="width:${percent}%;"></div></div>
                            <div class="progress-groups">${groupsBrief}</div>
                            <div class="progress-actions" style="margin-top:8px;">
                                <button class="btn btn-sm btn-danger" onclick="cancelPost(${p.post_id})">Cancel</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        } else {
            card.style.display = 'none';
            if (listEl) listEl.innerHTML = '';
        }
    function formatEta(ms) {
        const mins = Math.floor(ms/60000);
        const hrs = Math.floor(mins/60);
        const rem = mins%60;
        if (hrs >= 24) {
            const days = Math.floor(hrs/24);
            return `${days}d`;
        } else if (hrs > 0) {
            return `${hrs}h ${rem}m`;
        } else {
            return `${mins}m`;
        }
    }
    } catch (_) {}
}

pollPostingStatus();
setInterval(pollPostingStatus, 5000);

// Load scheduled posts
async function loadSchedules() {
    try {
        const res = await fetch('/api/schedule');
        const data = await res.json();
        const list = document.getElementById('scheduleList');
        if (!data.success) { list.innerHTML = '<div class="error">Failed to load schedules</div>'; return; }
        const schedules = data.schedules || [];
        if (schedules.length === 0) { list.innerHTML = '<div class="empty-state"><h3>No scheduled posts</h3><p>Create a scheduled post from the Post page.</p></div>'; return; }
        list.innerHTML = schedules.map(s => `
            <div class="schedule-card">
                <div class="schedule-main">
                    <div class="schedule-time">
                        <strong>${new Date(s.schedule_time).toLocaleString()}</strong>
                        ${s.recurring ? `<span class="badge badge-warning">Every ${s.interval_hours}h</span>` : ''}
                        ${s.status === 'paused' ? `<span class="badge badge-inactive" style="margin-left:8px;">Paused</span>` : ''}
                    </div>
                    <div class="schedule-content">${escapeHtml(s.content).slice(0, 200)}${s.content.length > 200 ? '‚Ä¶' : ''}</div>
                    <div class="schedule-groups">${(s.groups||[]).map(g => `<span class="group-tag">${escapeHtml(g)}</span>`).join('')}</div>
                </div>
                <div class="schedule-actions">
                    ${s.status === 'paused'
                        ? `<button class="btn btn-sm btn-success" onclick="resumeSchedule(${s.id})">Resume</button>`
                        : `<button class="btn btn-sm btn-warning" onclick="pauseSchedule(${s.id})">Pause</button>`}
                    <button class="btn btn-sm btn-danger" onclick="deleteSchedule(${s.id})">Delete</button>
                </div>
            </div>
        `).join('');
    } catch (e) {
        document.getElementById('scheduleList').innerHTML = '<div class="error">Error loading schedules</div>';
    }
}

function escapeHtml(text) {
    const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#039;' };
    return String(text).replace(/[&<>"']/g, m => map[m]);
}

async function deleteSchedule(id) {
    try {
        const res = await fbAutoPoster.csrfFetch(`/api/schedule/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
            fbAutoPoster.showNotification('Schedule deleted', 'success');
            loadSchedules();
        } else {
            fbAutoPoster.showNotification('Failed to delete schedule', 'error');
        }
    } catch (e) {
        fbAutoPoster.showNotification('Error deleting schedule', 'error');
    }
}

async function pauseSchedule(id) {
    try {
        const res = await fbAutoPoster.csrfFetch(`/api/schedule/${id}/pause`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
            fbAutoPoster.showNotification('Schedule paused', 'success');
            loadSchedules();
        } else {
            fbAutoPoster.showNotification('Failed to pause schedule', 'error');
        }
    } catch (e) {
        fbAutoPoster.showNotification('Error pausing schedule', 'error');
    }
}

async function resumeSchedule(id) {
    try {
        const res = await fbAutoPoster.csrfFetch(`/api/schedule/${id}/resume`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
            fbAutoPoster.showNotification('Schedule resumed', 'success');
            loadSchedules();
        } else {
            fbAutoPoster.showNotification('Failed to resume schedule', 'error');
        }
    } catch (e) {
        fbAutoPoster.showNotification('Error resuming schedule', 'error');
    }
}

async function cancelPost(postId) {
    if (!confirm('Cancel this active posting job?')) return;
    try {
        const res = await fbAutoPoster.csrfFetch(`/api/post/cancel/${postId}`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
            fbAutoPoster.showNotification('Posting job cancelled', 'success');
            pollPostingStatus();
        } else {
            fbAutoPoster.showNotification('Failed to cancel job', 'error');
        }
    } catch (e) {
        fbAutoPoster.showNotification('Error cancelling job', 'error');
    }
}

loadSchedules();

// Analytics Charts
let dailyChart = null;
let successChart = null;

async function loadAnalytics() {
    try {
        const res = await fetch('/api/analytics');
        const data = await res.json();
        if (!data.success) return;

        // Daily posts chart
        const dailyData = data.daily_posts || [];
        const ctx1 = document.getElementById('dailyChart');
        if (ctx1 && typeof Chart !== 'undefined') {
            if (dailyChart) dailyChart.destroy();
            dailyChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: dailyData.map(d => d.date),
                    datasets: [{
                        label: 'Posts',
                        data: dailyData.map(d => d.count),
                        backgroundColor: '#1976d2',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // Success rate chart
        const statusCounts = data.status_counts || {};
        const posted = statusCounts.posted || 0;
        const failed = statusCounts.failed || 0;
        const total = posted + failed;
        const ctx2 = document.getElementById('successChart');
        if (ctx2 && typeof Chart !== 'undefined' && total > 0) {
            if (successChart) successChart.destroy();
            successChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Success', 'Failed'],
                    datasets: [{
                        data: [posted, failed],
                        backgroundColor: ['#388e3c', '#d32f2f']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // Top groups
        const topGroups = data.top_groups || [];
        const groupsList = document.getElementById('topGroupsList');
        if (groupsList) {
            if (topGroups.length === 0) {
                groupsList.innerHTML = '<p class="text-muted">No data yet</p>';
            } else {
                groupsList.innerHTML = topGroups.slice(0, 5).map((g, i) => `
                    <div class="top-group-item">
                        <span class="rank">#${i + 1}</span>
                        <span class="name">${escapeHtml(g.name)}</span>
                        <span class="count">${g.posts} posts</span>
                    </div>
                `).join('');
            }
        }
    } catch (e) {
        console.error('Analytics error:', e);
    }
}

async function loadBestTimes() {
    try {
        const res = await fetch('/api/analytics/best-times');
        const data = await res.json();
        const list = document.getElementById('bestTimesList');
        if (!list) return;
        
        if (!data.success || !data.best_times || data.best_times.length === 0) {
            list.innerHTML = '<p class="text-muted">Post more to see best times</p>';
            return;
        }
        
        list.innerHTML = data.best_times.slice(0, 5).map(t => `
            <div class="best-time-item">
                <span class="time">${t.hour}:00</span>
                <span class="rate">${Math.round(t.success_rate * 100)}% success</span>
            </div>
        `).join('');
    } catch (e) {
        console.error('Best times error:', e);
    }
}

// Quick Setup Functions
function dismissQuickSetup() {
    const section = document.getElementById('quickSetupSection');
    if (section) {
        section.style.display = 'none';
        localStorage.setItem('quickSetupDismissed', 'true');
    }
}

// Check Facebook Session Status with Enhanced Endpoint
async function checkFacebookSession() {
    try {
        // Use new enhanced /api/facebook-status endpoint
        const response = await fetch('/api/facebook-status', {
            headers: { 'X-CSRF-Token': (window.csrfToken || '') }
        });
        const data = await response.json();
        
        const card = document.getElementById('fbSessionCard');
        const icon = document.getElementById('sessionIcon');
        const title = document.getElementById('sessionTitle');
        const message = document.getElementById('sessionMessage');
        const btn = document.getElementById('sessionActionBtn');
        
        if (data.connected && data.authenticated) {
            // Connected state
            card.style.borderLeftColor = '#10b981';
            card.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%)';
            icon.innerHTML = '<span style="animation: pulse 2s infinite;">‚úì</span>';
            icon.style.color = '#10b981';
            title.style.color = '#166534';
            title.textContent = 'Facebook Session Active';
            message.style.color = '#15803d';
            message.innerHTML = `<strong>Connected as:</strong> ${data.email}<br><small style="opacity: 0.8;">Session will persist for 7 days</small>`;
            btn.style.display = 'inline-block';
            btn.textContent = 'Logout';
            btn.className = 'btn btn-outline-danger';
            btn.onclick = () => handleFacebookLogout();
        } else {
            // Not connected state
            card.style.borderLeftColor = '#ef4444';
            card.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%)';
            icon.innerHTML = '‚ö†Ô∏è';
            icon.style.color = '#dc2626';
            title.style.color = '#991b1b';
            title.textContent = 'Facebook Session Not Connected';
            message.style.color = '#991b1b';
            message.textContent = 'Login to Facebook to discover groups and create posts.';
            btn.style.display = 'inline-block';
            btn.textContent = 'Login to Facebook';
            btn.className = 'btn btn-primary';
            btn.onclick = () => window.location.href = '/login';
        }
        card.style.display = 'block';
    } catch (e) {
        console.error('Failed to check session:', e);
    }
}

// Handle Facebook Logout with Smooth Transitions
async function handleFacebookLogout() {
    if (!confirm('Are you sure you want to logout from Facebook? You will need to login again to post.')) {
        return;
    }
    
    const btn = document.getElementById('sessionActionBtn');
    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = 'Logging out...';
    
    try {
        const response = await fetch('/api/facebook-logout', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRF-Token': (window.csrfToken || '')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Smooth fade out and update
            const card = document.getElementById('fbSessionCard');
            card.style.animation = 'fadeOut 0.3s ease';
            
            setTimeout(() => {
                checkFacebookSession();
            }, 300);
            
            // Show toast notification
            showToastNotification('‚úì Successfully logged out from Facebook', 'success');
        } else {
            throw new Error(data.error || 'Logout failed');
        }
    } catch (error) {
        btn.disabled = false;
        btn.textContent = originalText;
        showToastNotification('‚ùå Logout failed: ' + error.message, 'error');
        console.error('Logout error:', error);
    }
}

// Toast Notification System
function showToastNotification(message, type = 'info') {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 16px 20px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        animation: slideIn 0.3s ease;
        z-index: 9999;
        font-weight: 500;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function showQuickSetupIfNeeded() {
    const dismissed = localStorage.getItem('quickSetupDismissed');
    if (!dismissed) {
        const section = document.getElementById('quickSetupSection');
        if (section) {
            section.style.display = 'block';
        }
    }
}

// Show quick setup on first visit
document.addEventListener('DOMContentLoaded', showQuickSetupIfNeeded);

function exportAnalytics() {
    window.location.href = '/api/analytics/export?days=30';
}

// Load Chart.js dynamically
function loadChartJs() {
    if (typeof Chart !== 'undefined') {
        loadAnalytics();
        loadBestTimes();
        return;
    }
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
    script.onload = () => {
        loadAnalytics();
        loadBestTimes();
    };
    document.head.appendChild(script);
}

// Add smooth transition animations
const styleSheet = document.createElement('style');
styleSheet.textContent = `
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(100px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    @keyframes slideOut {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(100px);
        }
    }
    
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn:active {
        transform: translateY(0);
    }
    
    .session-card {
        animation: fadeIn 0.3s ease;
        transition: all 0.3s ease;
    }
`;
document.head.appendChild(styleSheet);

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    showQuickSetupIfNeeded();
    checkFacebookSession();
    loadChartJs();
});
</script>
{% endblock %}
