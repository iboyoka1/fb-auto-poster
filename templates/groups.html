{% extends "base.html" %}

{% block title %}Manage Groups - FB Auto Poster{% endblock %}

{% block body %}
<div class="dashboard">
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()" aria-label="Toggle menu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>
    
    <!-- Sidebar Overlay (for mobile) -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <nav class="sidebar">
        <div class="sidebar-header">
            <svg class="logo-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
            <span>FB Auto Poster</span>
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="/dashboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Dashboard
                </a>
            </li>
            <li class="nav-item active">
                <a href="/groups">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Manage Groups
                </a>
            </li>
            <li class="nav-item">
                <a href="/post">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Create Post
                </a>
            </li>
            <li class="nav-item">
                <a href="/history">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                        <polyline points="17 6 23 6 23 12"></polyline>
                    </svg>
                    Post History
                </a>
            </li>
            <!-- Hidden: Templates, Media Library, Analytics -->
            <li class="nav-item">
                <a href="/accounts">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    Accounts
                </a>
            </li>
        </ul>
        
        <div class="sidebar-footer">
            <a href="/logout" class="btn-logout">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Logout
            </a>
        </div>
    </nav>
    
    <main class="main-content">
        <header class="content-header">
            <h2>Manage Facebook Groups</h2>
            <div style="display: flex; gap: 10px;">
                <button id="discoverGroupsBtn" class="btn btn-success" title="Auto-discover all your Facebook groups">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px; height:18px; display:inline; margin-right:6px;">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Auto-Discover Groups
                </button>
                <button id="addGroupBtn" class="btn btn-primary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Add Group
                </button>
            </div>
        </header>
        <div class="toolbar" style="display:flex; gap:12px; align-items:center; margin-bottom:16px;">
            <input type="text" id="groupSearch" placeholder="Search groups by name or username" style="flex:1; padding:10px; border:2px solid #e5e7eb; border-radius:8px;">
            <label class="btn btn-secondary" for="csvFile">Select CSV</label>
            <input type="file" id="csvFile" accept=".csv" style="display:none;" />
            <button id="importCsvBtn" class="btn btn-secondary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="16 16 12 12 8 16"></polyline>
                    <line x1="12" y1="12" x2="12" y2="21"></line>
                    <path d="M20 12a8 8 0 1 0-16 0"></path>
                </svg>
                Import CSV
            </button>
        </div>
        
        <div class="groups-container">
            <div id="groupsList" class="groups-list">
                <div class="loading">Loading groups...</div>
            </div>
        </div>
    </main>
</div>

<!-- Add/Edit Group Modal -->
<div id="groupModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Add New Group</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <form id="groupForm">
            <input type="hidden" id="groupIndex" value="">
            <div class="form-group">
                <label for="groupName">Group Name *</label>
                <input type="text" id="groupName" required placeholder="Enter group name">
            </div>
            <div class="form-group">
                <label for="groupUsername">Group Username/ID *</label>
                <input type="text" id="groupUsername" required placeholder="e.g., algorithmicsmn or 1579795602330616">
                <small>Find this in the group URL: facebook.com/groups/<strong>username</strong></small>
            </div>
            <div class="form-group">
                <label for="groupStatus">Status</label>
                <select id="groupStatus">
                    <option value="straight">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Group</button>
            </div>
        </form>
    </div>
</div>

<script>
let groups = [];
let editIndex = -1;
let currentFilter = '';

async function ensureFacebookLogin() {
    try {
        const res = await fetch('/api/session-status');
        const data = await res.json();
        if (!data.success) return;
        if (!data.has_session || !data.valid) {
            // Attempt auto-login using server-side stored credentials
            const loginRes = await fetch('/api/fb-auto-login', { method: 'POST' });
            const loginData = await loginRes.json();
            if (!loginData.success) {
                console.warn('Auto-login failed:', loginData.error);
            }
        }
    } catch (e) {
        console.warn('Session check failed:', e);
    }
}

async function loadGroups() {
    try {
        const response = await fetch('/api/groups');
        const data = await response.json();
        
        if (data.success) {
            groups = data.groups;
            renderGroups();
        } else {
            document.getElementById('groupsList').innerHTML = `<div class="error">Failed to load groups: ${data.error}</div>`;
        }
    } catch (error) {
        document.getElementById('groupsList').innerHTML = `<div class="error">Error loading groups: ${error.message}</div>`;
    }
}

function renderGroups() {
    const container = document.getElementById('groupsList');
    const filtered = !currentFilter ? groups : groups.filter(g => {
        const q = currentFilter.toLowerCase();
        return (g.name || '').toLowerCase().includes(q) || (g.username || '').toLowerCase().includes(q);
    });
    
    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
                <h3>No matching groups</h3>
                <p>Try a different search or use "Auto-Discover Groups" to find your Facebook groups</p>
                <button onclick="discoverGroups()" class="btn btn-primary" style="margin-top: 15px;">
                    Discover Groups Now
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="groups-stats">
            <div class="stat-box">
                <span class="stat-icon">üìä</span>
                <div>
                    <div class="stat-label">Total Groups</div>
                    <div class="stat-value">${filtered.length}</div>
                </div>
            </div>
            <div class="stat-box">
                <span class="stat-icon">‚úì</span>
                <div>
                    <div class="stat-label">Active</div>
                    <div class="stat-value">${filtered.filter(g => g.status === 'straight').length}</div>
                </div>
            </div>
            <div class="stat-box">
                <span class="stat-icon">‚è∏</span>
                <div>
                    <div class="stat-label">Inactive</div>
                    <div class="stat-value">${filtered.filter(g => g.status !== 'straight').length}</div>
                </div>
            </div>
        </div>
        
        <div class="groups-table-wrapper">
            <table class="groups-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">#</th>
                        <th style="width: 40%;">Group Name</th>
                        <th style="width: 25%;">Username/ID</th>
                        <th style="width: 15%;">Status</th>
                        <th style="width: 15%;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${filtered.map((group, index) => {
                        const realIndex = groups.indexOf(group);
                        const isActive = group.status === 'straight';
                        return `
                            <tr class="group-row ${isActive ? 'active' : 'inactive'}">
                                <td class="row-number">${index + 1}</td>
                                <td class="group-name">
                                    <div class="group-name-cell">
                                        <svg viewBox="0 0 24 24" fill="currentColor" style="width: 24px; height: 24px; color: #1877f2; margin-right: 12px;">
                                            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                                        </svg>
                                        <strong>${escapeHtml(group.name)}</strong>
                                    </div>
                                </td>
                                <td class="group-username">
                                    <code style="background: #f0f2f5; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${escapeHtml(group.username)}</code>
                                </td>
                                <td class="group-status">
                                    <span class="status-badge ${isActive ? 'status-active' : 'status-inactive'}">
                                        ${isActive ? '‚úì Active' : '‚è∏ Inactive'}
                                    </span>
                                </td>
                                <td class="group-actions-cell">
                                    <div class="action-buttons">
                                        <button class="btn-action btn-edit" onclick="editGroup(${realIndex})" title="Edit">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                            </svg>
                                        </button>
                                        <button class="btn-action btn-toggle" onclick="toggleStatus(${realIndex})" title="Toggle Status">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="3" y="7" width="18" height="10" rx="2"></rect>
                                                ${isActive ? '<circle cx="16" cy="12" r="3"></circle>' : '<circle cx="8" cy="12" r="3"></circle>'}
                                            </svg>
                                        </button>
                                        <button class="btn-action btn-delete" onclick="deleteGroup(${realIndex})" title="Delete">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function openModal(title = 'Add New Group') {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('groupModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('groupModal').style.display = 'none';
    document.getElementById('groupForm').reset();
    document.getElementById('groupIndex').value = '';
    editIndex = -1;
}

function editGroup(index) {
    const group = groups[index];
    editIndex = index;
    
    document.getElementById('groupIndex').value = index;
    document.getElementById('groupName').value = group.name;
    document.getElementById('groupUsername').value = group.username;
    document.getElementById('groupStatus').value = group.status || 'straight';
    
    openModal('Edit Group');
}

async function deleteGroup(index) {
    if (!confirm(`Are you sure you want to delete "${groups[index].name}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/groups/${index}`, {
            method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.success) {
            await loadGroups();
        } else {
            alert('Failed to delete group: ' + data.error);
        }
    } catch (error) {
        alert('Error deleting group: ' + error.message);
    }
}

async function toggleStatus(index) {
    try {
        const group = groups[index];
        const newStatus = group.status === 'straight' ? 'inactive' : 'straight';
        const response = await fetch(`/api/groups/${index}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: group.name,
                username: group.username,
                status: newStatus
            })
        });
        const data = await response.json();
        if (data.success) {
            groups[index].status = newStatus;
            renderGroups();
        } else {
            alert('Failed to update status: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        alert('Error updating status: ' + e.message);
    }
}

document.getElementById('addGroupBtn').addEventListener('click', () => {
    openModal('Add New Group');
});

document.getElementById('groupSearch').addEventListener('input', (e) => {
    currentFilter = e.target.value || '';
    renderGroups();
});

document.getElementById('importCsvBtn').addEventListener('click', async () => {
    const fileInput = document.getElementById('csvFile');
    if (!fileInput.files || !fileInput.files[0]) {
        alert('Please select a CSV file first.');
        return;
    }
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    try {
        const res = await fetch('/api/csv-import', {
            method: 'POST',
            body: formData
        });
        const data = await res.json();
        if (data.success) {
            alert(`Imported ${data.imported} groups from CSV`);
            currentFilter = '';
            document.getElementById('groupSearch').value = '';
            await loadGroups();
        } else {
            alert('Import failed: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        alert('Error importing CSV: ' + e.message);
    }
});

document.getElementById('groupForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const groupData = {
        name: document.getElementById('groupName').value,
        username: document.getElementById('groupUsername').value,
        status: document.getElementById('groupStatus').value
    };
    
    try {
        const isEdit = editIndex !== -1;
        const url = isEdit ? `/api/groups/${editIndex}` : '/api/groups';
        const method = isEdit ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(groupData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            closeModal();
            await loadGroups();
        } else {
            alert('Failed to save group: ' + data.error);
        }
    } catch (error) {
        alert('Error saving group: ' + error.message);
    }
});

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('groupModal');
    if (event.target === modal) {
        closeModal();
    }
}

// Auto-discover groups button
document.getElementById('discoverGroupsBtn').addEventListener('click', async function() {
    const btn = this;
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<span style="display:inline-block; width:16px; height:16px; border:2px solid #f3f3f3; border-top:2px solid #667eea; border-radius:50%; animation:spin 1s linear infinite; margin-right:6px; vertical-align:middle;"></span> Discovering...';
    
    try {
        const response = await fetch('/api/discover-groups', {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success && data.groups.length > 0) {
            showDiscoveryResults(data.groups);
        } else if (!data.success) {
            alert('Error: ' + data.message);
        } else {
            alert('No groups found');
        }
    } catch (error) {
        alert('Error discovering groups: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
});

function showDiscoveryResults(discoveredGroups) {
    const html = `
    <div id="discoveryModal" class="modal" style="display:block;">
        <div class="modal-content" style="max-width:600px;">
            <div class="modal-header">
                <h3>Discovered ${discoveredGroups.length} Groups</h3>
                <button class="modal-close" onclick="closeDiscoveryModal()">&times;</button>
            </div>
            <div style="max-height: 400px; overflow-y: auto; padding: 20px; border-bottom: 1px solid #e5e7eb;">
                <div id="discoveredGroupsList"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDiscoveryModal()">Cancel</button>
                <button type="button" class="btn btn-success" onclick="addSelectedDiscoveredGroups()">Add Selected Groups</button>
            </div>
        </div>
    </div>
    `;
    
    const oldModal = document.getElementById('discoveryModal');
    if (oldModal) oldModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', html);
    
    const list = document.getElementById('discoveredGroupsList');
    discoveredGroups.forEach((group, index) => {
        const item = document.createElement('div');
        item.style.cssText = 'display:flex; align-items:center; padding:10px 0; border-bottom:1px solid #f0f0f0;';
        item.innerHTML = `
            <input type="checkbox" class="discovered-group-checkbox" value="${index}" data-name="${group.name}" data-username="${group.username}" checked style="margin-right:12px; width:18px; height:18px; cursor:pointer;">
            <div style="flex:1;">
                <strong>${group.name}</strong>
                <br>
                <small style="color:#666;">${group.username}</small>
            </div>
        `;
        list.appendChild(item);
    });
}

function closeDiscoveryModal() {
    const modal = document.getElementById('discoveryModal');
    if (modal) modal.remove();
}

async function addSelectedDiscoveredGroups() {
    const checkboxes = document.querySelectorAll('.discovered-group-checkbox:checked');
    const groupsToAdd = [];
    
    checkboxes.forEach(checkbox => {
        groupsToAdd.push({
            name: checkbox.getAttribute('data-name'),
            username: checkbox.getAttribute('data-username'),
            status: 'member'
        });
    });
    
    if (groupsToAdd.length === 0) {
        alert('Please select at least one group');
        return;
    }
    
    try {
        const response = await fetch('/api/groups/bulk-add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({groups: groupsToAdd})
        });
        
        const data = await response.json();
        
        if (data.success) {
            closeDiscoveryModal();
            await loadGroups();
            alert('Successfully added groups!');
        } else {
            alert('Error adding groups: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Load groups immediately; check login in background to avoid blocking UI
loadGroups();
ensureFacebookLogin().catch(() => {});
</script>
{% endblock %}
