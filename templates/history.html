{% extends "base.html" %}

{% block title %}Historique des Publications - {{ app_name|default('FB Auto Poster') }}{% endblock %}

{% block body %}
<div class="dashboard">
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()" aria-label="Toggle menu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>
    
    <!-- Sidebar Overlay (for mobile) -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <nav class="sidebar">
        <div class="sidebar-header">
            <svg class="logo-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
            <span>{{ app_name|default('FB Auto Poster') }}</span>
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="/dashboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Tableau de Bord
                </a>
            </li>
            <li class="nav-item">
                <a href="/groups">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Gérer les Groupes
                </a>
            </li>
            <li class="nav-item">
                <a href="/post">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Créer une Publication
                </a>
            </li>
            <li class="nav-item active">
                <a href="/history">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                        <polyline points="17 6 23 6 23 12"></polyline>
                    </svg>
                    Historique
                </a>
            </li>
            <!-- Hidden: Templates, Media Library, Analytics -->
            <li class="nav-item">
                <a href="/accounts">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    Comptes
                </a>
            </li>
        </ul>
        
        <div class="sidebar-footer">
            <a href="/logout" class="btn-logout">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Déconnexion
            </a>
        </div>
    </nav>
    
    <main class="main-content">
        <header class="content-header">
            <h2>Historique des Publications</h2>
            <button onclick="loadHistory()" class="btn btn-secondary btn-sm">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                </svg>
                Actualiser
            </button>
        </header>
        
        <div class="history-container">
            <div id="historyList" class="history-list">
                <div class="loading">Chargement de l'historique...</div>
            </div>
        </div>
    </main>
</div>

<script>
async function loadHistory() {
    const container = document.getElementById('historyList');
    container.innerHTML = '<div class="loading">Loading history...</div>';
    
    try {
        const response = await fetch('/api/history');
        const data = await response.json();
        
        if (data.success) {
            renderHistory(data.posts);
        } else {
            container.innerHTML = `<div class="error">Failed to load history: ${data.error}</div>`;
        }
    } catch (error) {
        container.innerHTML = `<div class="error">Error loading history: ${error.message}</div>`;
    }
}

function renderHistory(posts) {
    const container = document.getElementById('historyList');
    
    if (posts.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                    <polyline points="17 6 23 6 23 12"></polyline>
                </svg>
                <h3>No posts yet</h3>
                <p>Create your first post to see it here</p>
                <a href="/post" class="btn btn-primary">Create Post</a>
            </div>
        `;
        return;
    }
    
    container.innerHTML = posts.map(post => {
        const date = new Date(post.timestamp);
        const statusClass = post.status === 'posted' ? 'badge-success' : 
                           post.status === 'posting' ? 'badge-warning' : 'badge-danger';
        
        // Render media thumbnails if present
        let mediaThumbnails = '';
        if (post.media && post.media.length > 0) {
            mediaThumbnails = `
                <div class="history-media" style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px;">
                    ${post.media.map((url, idx) => {
                        const isVideo = url.match(/\.(mp4|mov|webm|avi)$/i);
                        if (isVideo) {
                            return `
                                <div class="media-thumb" style="position: relative; width: 80px; height: 80px; border-radius: 8px; overflow: hidden; cursor: pointer; background: #1a1a2e;" onclick="openMediaLightbox('${url}', true)">
                                    <video src="${url}" style="width: 100%; height: 100%; object-fit: cover;"></video>
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.6); border-radius: 50%; padding: 8px;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                                    </div>
                                </div>
                            `;
                        } else {
                            return `
                                <div class="media-thumb" style="width: 80px; height: 80px; border-radius: 8px; overflow: hidden; cursor: pointer;" onclick="openMediaLightbox('${url}', false)">
                                    <img src="${url}" alt="Media ${idx + 1}" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                            `;
                        }
                    }).join('')}
                </div>
            `;
        }
        
        return `
            <div class="history-card">
                <div class="history-header">
                    <div>
                        <h4>Post #${post.id}</h4>
                        <p class="text-muted">${formatDate(date)}</p>
                    </div>
                    <span class="badge ${statusClass}">${post.status}</span>
                </div>
                <div class="history-content">
                    <p>${escapeHtml(post.content).replace(/\n/g, '<br>')}</p>
                    ${mediaThumbnails}
                </div>
                <div class="history-footer">
                    <div class="posted-groups">
                        <strong>Posted to ${post.groups.length} group(s):</strong>
                        ${post.groups.map(g => `<span class="group-tag">${escapeHtml(g)}</span>`).join('')}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Lightbox for viewing media full size
function openMediaLightbox(url, isVideo) {
    const existing = document.getElementById('mediaLightbox');
    if (existing) existing.remove();
    
    const lightbox = document.createElement('div');
    lightbox.id = 'mediaLightbox';
    lightbox.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; cursor: pointer;';
    lightbox.onclick = () => lightbox.remove();
    
    let content;
    if (isVideo) {
        content = document.createElement('video');
        content.src = url;
        content.controls = true;
        content.autoplay = true;
        content.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px;';
    } else {
        content = document.createElement('img');
        content.src = url;
        content.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px; object-fit: contain;';
    }
    content.onclick = (e) => e.stopPropagation();
    
    lightbox.appendChild(content);
    document.body.appendChild(lightbox);
    
    // Close on Escape key
    document.addEventListener('keydown', function handler(e) {
        if (e.key === 'Escape') {
            lightbox.remove();
            document.removeEventListener('keydown', handler);
        }
    });
}

function formatDate(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
    
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// Prevent concurrent fetches
let isPolling = false;
let pollIntervalId = null;

async function pollHistory() {
    // Skip if already fetching
    if (isPolling) return;
    isPolling = true;
    
    try {
        const response = await fetch('/api/history');
        
        // Check for auth redirect (session expired)
        if (response.redirected || response.status === 401 || response.status === 403) {
            // Stop polling on auth failure - don't reload
            if (pollIntervalId) {
                clearInterval(pollIntervalId);
                pollIntervalId = null;
            }
            console.warn('Session may have expired. Stopped history polling.');
            return;
        }
        
        const data = await response.json();
        
        if (data.success) {
            renderHistory(data.posts);
        }
        // On failure, just keep existing content - don't reload
    } catch (error) {
        // Network error - just log, don't reload page
        console.error('History poll failed:', error.message);
    } finally {
        isPolling = false;
    }
}

// Initial load (not full page reload)
loadHistory();

// Safe polling every 10 seconds - only updates data, never reloads page
pollIntervalId = setInterval(pollHistory, 10000);

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (pollIntervalId) {
        clearInterval(pollIntervalId);
        pollIntervalId = null;
    }
});
</script>
{% endblock %}
