{% extends "base.html" %}

{% block title %}Media Library - FB Auto Poster{% endblock %}

{% block body %}
<div class="dashboard">
    <nav class="sidebar">
        <div class="sidebar-header">
            <svg class="logo-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
            <span>FB Auto Poster</span>
        </div>
        
        <button class="mobile-menu-toggle" onclick="toggleSidebar()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="/dashboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a href="/groups">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Manage Groups
                </a>
            </li>
            <li class="nav-item">
                <a href="/post">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Create Post
                </a>
            </li>
            <li class="nav-item">
                <a href="/templates">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                    </svg>
                    Templates
                </a>
            </li>
            <li class="nav-item active">
                <a href="/media">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    Media Library
                </a>
            </li>
            <li class="nav-item">
                <a href="/accounts">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    Accounts
                </a>
            </li>
            <li class="nav-item">
                <a href="/analytics">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                    Analytics
                </a>
            </li>
            <li class="nav-item">
                <a href="/history">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                        <polyline points="17 6 23 6 23 12"></polyline>
                    </svg>
                    Post History
                </a>
            </li>
        </ul>
        
        <div class="sidebar-footer">
            <a href="/logout" class="btn-logout">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Logout
            </a>
        </div>
    </nav>
    
    <main class="main-content">
        <header class="content-header">
            <h2>Media Library</h2>
            <button class="btn btn-primary" onclick="showUploadModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Upload Media
            </button>
        </header>
        
        <div class="media-toolbar">
            <div class="media-filters">
                <select id="typeFilter" onchange="filterMedia()">
                    <option value="">All Types</option>
                    <option value="image">Images</option>
                    <option value="video">Videos</option>
                </select>
                <select id="collectionFilter" onchange="filterMedia()">
                    <option value="">All Collections</option>
                </select>
                <input type="text" id="searchMedia" placeholder="Search by name or tag..." oninput="filterMedia()">
            </div>
            <div class="media-view-toggle">
                <button class="btn btn-sm btn-icon active" onclick="setView('grid')" id="gridViewBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                </button>
                <button class="btn btn-sm btn-icon" onclick="setView('list')" id="listViewBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="8" y1="6" x2="21" y2="6"></line>
                        <line x1="8" y1="12" x2="21" y2="12"></line>
                        <line x1="8" y1="18" x2="21" y2="18"></line>
                        <line x1="3" y1="6" x2="3.01" y2="6"></line>
                        <line x1="3" y1="12" x2="3.01" y2="12"></line>
                        <line x1="3" y1="18" x2="3.01" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>

        <div class="dashboard-section">
            <div class="section-header">
                <h3>Collections</h3>
                <button class="btn btn-sm btn-secondary" onclick="showCreateCollectionModal()">+ New Collection</button>
            </div>
            <div id="collectionsList" class="collections-grid">
                <div class="loading">Loading collections...</div>
            </div>
        </div>
        
        <div class="dashboard-section">
            <div class="section-header">
                <h3>Media Files</h3>
                <span id="mediaCount" class="text-muted"></span>
            </div>
            <div id="mediaList" class="media-grid">
                <div class="loading">Loading media...</div>
            </div>
        </div>
    </main>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Upload Media</h3>
            <button class="btn-close" onclick="closeUploadModal()">&times;</button>
        </div>
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p>Click to upload or drag & drop</p>
                <span>Images: JPG, PNG, GIF | Videos: MP4, MOV (max 50MB)</span>
                <input type="file" id="fileInput" accept="image/*,video/*" multiple hidden onchange="handleFileSelect(this)">
            </div>
            <div id="selectedFiles" class="selected-files"></div>
            <div class="form-group">
                <label for="uploadName">Name (optional)</label>
                <input type="text" id="uploadName" placeholder="Display name">
            </div>
            <div class="form-group">
                <label for="uploadTags">Tags (comma-separated)</label>
                <input type="text" id="uploadTags" placeholder="product, banner, sale">
            </div>
            <div class="form-group">
                <label for="uploadCollection">Add to Collection</label>
                <select id="uploadCollection">
                    <option value="">No collection</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUploadModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="uploadBtn">Upload</button>
            </div>
        </form>
    </div>
</div>

<!-- Collection Modal -->
<div id="collectionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create Collection</h3>
            <button class="btn-close" onclick="closeCollectionModal()">&times;</button>
        </div>
        <form id="collectionForm">
            <div class="form-group">
                <label for="collectionName">Collection Name *</label>
                <input type="text" id="collectionName" required placeholder="e.g., Product Images">
            </div>
            <div class="form-group">
                <label for="collectionDesc">Description</label>
                <textarea id="collectionDesc" rows="3" placeholder="Optional description..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeCollectionModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Collection</button>
            </div>
        </form>
    </div>
</div>

<!-- Media Preview Modal -->
<div id="mediaPreviewModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 id="previewTitle">Media Preview</h3>
            <button class="btn-close" onclick="closeMediaPreview()">&times;</button>
        </div>
        <div id="mediaPreviewContent" class="media-preview-container"></div>
        <div id="mediaDetails" class="media-details"></div>
        <div class="modal-footer">
            <button class="btn btn-danger" onclick="deleteSelectedMedia()">Delete</button>
            <button class="btn btn-secondary" onclick="closeMediaPreview()">Close</button>
            <button class="btn btn-primary" onclick="useSelectedMedia()">Use in Post</button>
        </div>
    </div>
</div>

<script>
let mediaFiles = [];
let collections = [];
let viewMode = 'grid';
let selectedMediaId = null;

async function loadMedia() {
    try {
        const res = await fetch('/api/media');
        const data = await res.json();
        
        if (!data.success) {
            document.getElementById('mediaList').innerHTML = '<div class="empty-state"><p>Media library not enabled</p></div>';
            return;
        }
        
        mediaFiles = data.files || [];
        renderMedia();
    } catch (e) {
        document.getElementById('mediaList').innerHTML = '<div class="error">Failed to load media</div>';
    }
}

async function loadCollections() {
    try {
        const res = await fetch('/api/media/collections');
        const data = await res.json();
        
        if (!data.success) return;
        
        collections = data.collections || [];
        renderCollections();
        updateCollectionDropdowns();
    } catch (e) {
        console.error('Failed to load collections');
    }
}

function renderCollections() {
    const list = document.getElementById('collectionsList');
    
    if (collections.length === 0) {
        list.innerHTML = `
            <div class="collection-card create-new" onclick="showCreateCollectionModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                <span>Create Collection</span>
            </div>
        `;
        return;
    }
    
    list.innerHTML = collections.map(c => `
        <div class="collection-card" onclick="filterByCollection('${c.id}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
            <h4>${escapeHtml(c.name)}</h4>
            <span>${c.file_count || 0} files</span>
        </div>
    `).join('') + `
        <div class="collection-card create-new" onclick="showCreateCollectionModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <span>New Collection</span>
        </div>
    `;
}

function updateCollectionDropdowns() {
    const filterDropdown = document.getElementById('collectionFilter');
    const uploadDropdown = document.getElementById('uploadCollection');
    
    const options = collections.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
    
    filterDropdown.innerHTML = '<option value="">All Collections</option>' + options;
    uploadDropdown.innerHTML = '<option value="">No collection</option>' + options;
}

function renderMedia() {
    const list = document.getElementById('mediaList');
    const countEl = document.getElementById('mediaCount');
    
    // Apply filters
    let filtered = [...mediaFiles];
    const typeFilter = document.getElementById('typeFilter').value;
    const collectionFilter = document.getElementById('collectionFilter').value;
    const search = document.getElementById('searchMedia').value.toLowerCase();
    
    if (typeFilter) {
        filtered = filtered.filter(f => f.type === typeFilter);
    }
    if (collectionFilter) {
        filtered = filtered.filter(f => f.collection_id === collectionFilter);
    }
    if (search) {
        filtered = filtered.filter(f => 
            (f.name || '').toLowerCase().includes(search) ||
            (f.tags || []).some(t => t.toLowerCase().includes(search))
        );
    }
    
    countEl.textContent = `${filtered.length} files`;
    
    if (filtered.length === 0) {
        list.innerHTML = `
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:48px;height:48px;margin-bottom:16px;opacity:0.5;">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                <h3>No media files</h3>
                <p>Upload images and videos to use in your posts</p>
                <button class="btn btn-primary" onclick="showUploadModal()">Upload Media</button>
            </div>
        `;
        return;
    }
    
    list.className = viewMode === 'grid' ? 'media-grid' : 'media-list';
    
    list.innerHTML = filtered.map(f => `
        <div class="media-item ${f.type}" onclick="previewMedia('${f.id}')">
            ${f.type === 'image' 
                ? `<img src="/uploads/${f.filename}" alt="${escapeHtml(f.name)}" loading="lazy">`
                : `<div class="video-thumbnail">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                   </div>`
            }
            <div class="media-info">
                <span class="media-name">${escapeHtml(f.name || f.filename)}</span>
                ${f.tags && f.tags.length ? `<span class="media-tags">${f.tags.slice(0, 3).join(', ')}</span>` : ''}
            </div>
            <div class="media-overlay">
                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); useMediaInPost('${f.id}')">Use</button>
            </div>
        </div>
    `).join('');
}

function filterMedia() {
    renderMedia();
}

function filterByCollection(id) {
    document.getElementById('collectionFilter').value = id;
    filterMedia();
}

function setView(mode) {
    viewMode = mode;
    document.getElementById('gridViewBtn').classList.toggle('active', mode === 'grid');
    document.getElementById('listViewBtn').classList.toggle('active', mode === 'list');
    renderMedia();
}

function showUploadModal() {
    document.getElementById('uploadForm').reset();
    document.getElementById('selectedFiles').innerHTML = '';
    document.getElementById('uploadModal').classList.add('active');
}

function closeUploadModal() {
    document.getElementById('uploadModal').classList.remove('active');
}

function handleFileSelect(input) {
    const files = input.files;
    const container = document.getElementById('selectedFiles');
    
    container.innerHTML = Array.from(files).map(f => `
        <div class="selected-file">
            <span>${escapeHtml(f.name)}</span>
            <span class="file-size">${formatFileSize(f.size)}</span>
        </div>
    `).join('');
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const fileInput = document.getElementById('fileInput');
    if (!fileInput.files.length) {
        fbAutoPoster.showNotification('Please select a file', 'error');
        return;
    }
    
    const btn = document.getElementById('uploadBtn');
    btn.disabled = true;
    btn.textContent = 'Uploading...';
    
    try {
        for (const file of fileInput.files) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('name', document.getElementById('uploadName').value || file.name);
            formData.append('tags', document.getElementById('uploadTags').value);
            
            const res = await fetch('/api/media', {
                method: 'POST',
                headers: { 'X-CSRF-Token': window.csrfToken },
                body: formData
            });
            
            const data = await res.json();
            
            if (!data.success) {
                fbAutoPoster.showNotification(`Failed to upload ${file.name}: ${data.error}`, 'error');
            }
        }
        
        fbAutoPoster.showNotification('Upload complete!', 'success');
        closeUploadModal();
        loadMedia();
    } catch (e) {
        fbAutoPoster.showNotification('Upload failed', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Upload';
    }
});

function showCreateCollectionModal() {
    document.getElementById('collectionForm').reset();
    document.getElementById('collectionModal').classList.add('active');
}

function closeCollectionModal() {
    document.getElementById('collectionModal').classList.remove('active');
}

document.getElementById('collectionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    try {
        const res = await fbAutoPoster.csrfFetch('/api/media/collections', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: document.getElementById('collectionName').value,
                description: document.getElementById('collectionDesc').value
            })
        });
        
        const data = await res.json();
        
        if (data.success) {
            fbAutoPoster.showNotification('Collection created!', 'success');
            closeCollectionModal();
            loadCollections();
        } else {
            fbAutoPoster.showNotification('Failed: ' + data.error, 'error');
        }
    } catch (e) {
        fbAutoPoster.showNotification('Error creating collection', 'error');
    }
});

function previewMedia(id) {
    const file = mediaFiles.find(f => f.id === id);
    if (!file) return;
    
    selectedMediaId = id;
    document.getElementById('previewTitle').textContent = file.name || file.filename;
    
    const content = document.getElementById('mediaPreviewContent');
    if (file.type === 'image') {
        content.innerHTML = `<img src="/uploads/${file.filename}" alt="${escapeHtml(file.name)}">`;
    } else {
        content.innerHTML = `<video controls><source src="/uploads/${file.filename}" type="video/mp4"></video>`;
    }
    
    document.getElementById('mediaDetails').innerHTML = `
        <div class="detail-row"><span>Type:</span> ${file.type}</div>
        <div class="detail-row"><span>Size:</span> ${formatFileSize(file.size || 0)}</div>
        <div class="detail-row"><span>Uploaded:</span> ${new Date(file.created_at).toLocaleDateString()}</div>
        ${file.tags && file.tags.length ? `<div class="detail-row"><span>Tags:</span> ${file.tags.join(', ')}</div>` : ''}
    `;
    
    document.getElementById('mediaPreviewModal').classList.add('active');
}

function closeMediaPreview() {
    document.getElementById('mediaPreviewModal').classList.remove('active');
    selectedMediaId = null;
}

async function deleteSelectedMedia() {
    if (!selectedMediaId) return;
    if (!confirm('Delete this file?')) return;
    
    try {
        const res = await fbAutoPoster.csrfFetch(`/api/media/${selectedMediaId}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (data.success) {
            fbAutoPoster.showNotification('File deleted', 'success');
            closeMediaPreview();
            loadMedia();
        }
    } catch (e) {
        fbAutoPoster.showNotification('Error deleting file', 'error');
    }
}

function useSelectedMedia() {
    if (selectedMediaId) {
        useMediaInPost(selectedMediaId);
    }
}

function useMediaInPost(id) {
    const file = mediaFiles.find(f => f.id === id);
    if (file) {
        localStorage.setItem('pendingMediaId', id);
        localStorage.setItem('pendingMediaPath', `/uploads/${file.filename}`);
        window.location.href = '/post';
    }
}

function escapeHtml(text) {
    const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#039;' };
    return String(text || '').replace(/[&<>"']/g, m => map[m]);
}

// Drag and drop
const uploadZone = document.getElementById('uploadZone');
uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});
uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});
uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    document.getElementById('fileInput').files = e.dataTransfer.files;
    handleFileSelect(document.getElementById('fileInput'));
});

// Initialize
loadMedia();
loadCollections();
</script>
{% endblock %}
