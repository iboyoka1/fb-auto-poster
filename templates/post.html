{% extends "base.html" %}

{% block title %}Create Post - FB Auto Poster{% endblock %}

{% block body %}
<div class="dashboard">
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()" aria-label="Toggle menu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>
    
    <!-- Sidebar Overlay (for mobile) -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <nav class="sidebar">
        <div class="sidebar-header">
            <svg class="logo-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
            <span>FB Auto Poster</span>
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="/dashboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a href="/groups">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Manage Groups
                </a>
            </li>
            <li class="nav-item active">
                <a href="/post">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Create Post
                </a>
            </li>
            <li class="nav-item">
                <a href="/history">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                        <polyline points="17 6 23 6 23 12"></polyline>
                    </svg>
                    Post History
                </a>
            </li>
            <!-- Hidden: Templates, Media Library, Analytics -->
            <li class="nav-item">
                <a href="/accounts">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    Accounts
                </a>
            </li>
        </ul>
        
        <div class="sidebar-footer">
            <a href="/logout" class="btn-logout">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Logout
            </a>
        </div>
    </nav>
    
    <main class="main-content">
        <header class="content-header">
            <h2>Create New Post</h2>
        </header>
        
        <div class="post-creator">
            <div class="post-form-container">
                <form id="postForm">
                    <div class="form-group">
                        <label for="postContent">Post Content * 
                            <span class="badge" style="background: #1877f2; color: white; margin-left: 10px;">NEW: Spintax Supported!</span>
                        </label>
                        <textarea id="postContent" rows="10" required placeholder="Write your post content here...

‚ú® NEW FEATURES:
- Spintax: {Hello|Hi|Hey} for unique variations
- Add images (see below)
- Schedule for later

Example: {Hey|Hello} everyone! Check out our {amazing|incredible} {new|latest} product!"></textarea>
                        <div class="char-count">
                            <span id="charCount">0</span> characters
                            <button type="button" onclick="previewSpintax()" class="btn-link" style="margin-left: 15px;">
                                üîÑ Preview Variations
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group" style="border: 2px dashed #1877f2; padding: 20px; border-radius: 8px; background: #f0f8ff;">
                        <label for="postMedia">üì∏üé• Upload Media (Multiple Images/Videos Supported!)</label>
                        <input type="file" id="postMedia" accept="image/*,video/*" multiple onchange="previewMedia(event)">
                        <p style="color: #666; font-size: 12px; margin-top: 5px;">Select multiple files: Images (JPG, PNG, GIF) or Videos (MP4, MOV)</p>
                        <div id="mediaPreview" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px;">
                            <!-- Media previews will appear here -->
                        </div>
                        <button type="button" onclick="clearAllMedia()" style="margin-top: 10px; padding: 5px 10px; display: none;" id="clearMediaBtn">Clear All</button>
                    </div>
                    
                    <!-- Improved Schedule Section -->
                    <div class="form-group schedule-section" style="background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%); padding: 20px; border-radius: 16px; border: 2px solid #e0e7ff;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 12px;">
                            <label style="font-weight:600; font-size: 15px; display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="schedulePost" onchange="toggleSchedule()" style="width: 20px; height: 20px; accent-color: #6366f1;"> 
                                <span style="display: flex; align-items: center; gap: 8px;">
                                    üìÖ <span>Schedule This Post</span>
                                </span>
                            </label>
                            <span id="nextRunLabel" class="schedule-badge" style="display:none; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; box-shadow: 0 2px 8px rgba(99,102,241,0.3);">
                                ‚è∞ Next: ‚Äî
                            </span>
                        </div>
                        
                        <div id="scheduleOptions" style="display: none; margin-top: 16px;">
                            <!-- Quick Schedule Buttons -->
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;">
                                <button type="button" class="quick-schedule-btn" onclick="setQuickSchedule('30m')" style="padding: 8px 16px; border: 2px solid #e0e7ff; background: white; border-radius: 20px; cursor: pointer; font-size: 13px; transition: all 0.2s;">‚ö° In 30 min</button>
                                <button type="button" class="quick-schedule-btn" onclick="setQuickSchedule('1h')" style="padding: 8px 16px; border: 2px solid #e0e7ff; background: white; border-radius: 20px; cursor: pointer; font-size: 13px; transition: all 0.2s;">üïê In 1 hour</button>
                                <button type="button" class="quick-schedule-btn" onclick="setQuickSchedule('3h')" style="padding: 8px 16px; border: 2px solid #e0e7ff; background: white; border-radius: 20px; cursor: pointer; font-size: 13px; transition: all 0.2s;">üïí In 3 hours</button>
                                <button type="button" class="quick-schedule-btn" onclick="setQuickSchedule('tomorrow')" style="padding: 8px 16px; border: 2px solid #e0e7ff; background: white; border-radius: 20px; cursor: pointer; font-size: 13px; transition: all 0.2s;">üåÖ Tomorrow 9AM</button>
                            </div>
                            
                            <!-- Date/Time Picker -->
                            <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid #e5e7eb; margin-bottom: 16px;">
                                <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 8px; font-weight: 500;">üìÜ Pick exact date & time</label>
                                <input type="datetime-local" id="scheduleTime" onchange="previewNextRun()" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: border-color 0.2s;" onfocus="this.style.borderColor='#6366f1'" onblur="this.style.borderColor='#e5e7eb'">
                                <div id="schedulePreview" style="margin-top: 10px; padding: 10px; background: #f0fdf4; border-radius: 8px; display: none;">
                                    <span style="color: #15803d; font-size: 13px;">‚úì <span id="schedulePreviewText"></span></span>
                                </div>
                            </div>
                            
                            <!-- Recurring Options -->
                            <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid #e5e7eb;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                    <input type="checkbox" id="recurring" onchange="toggleRecurring()" style="width: 18px; height: 18px; accent-color: #6366f1;">
                                    <span style="font-weight: 500;">üîÑ Make this a recurring post</span>
                                </label>
                                
                                <div id="recurringOptions" style="display: none; padding-left: 28px;">
                                    <!-- Interval Setting -->
                                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 16px;">
                                        <span style="color: #64748b; font-size: 14px;">Repeat every</span>
                                        <input type="number" id="intervalHours" min="1" value="1" style="width: 70px; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; text-align: center; font-size: 14px;">
                                        <select id="intervalUnit" style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white;">
                                            <option value="hours" selected>Hours</option>
                                            <option value="days">Days</option>
                                            <option value="weeks">Weeks</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Duration Setting -->
                                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; padding: 14px; background: #fef3c7; border-radius: 10px; border: 1px solid #fcd34d;">
                                        <span style="color: #92400e; font-size: 14px; font-weight: 500;">‚è±Ô∏è Duration:</span>
                                        <select id="durationType" onchange="toggleDurationInput()" style="padding: 8px 12px; border: 2px solid #fcd34d; border-radius: 8px; font-size: 14px; background: white;">
                                            <option value="forever">Run forever</option>
                                            <option value="days">Run for X days</option>
                                            <option value="times">Run X times</option>
                                        </select>
                                        <div id="durationValueContainer" style="display: none; align-items: center; gap: 8px;">
                                            <input type="number" id="durationValue" min="1" value="7" style="width: 70px; padding: 8px 12px; border: 2px solid #fcd34d; border-radius: 8px; text-align: center; font-size: 14px;">
                                            <span id="durationLabel" style="color: #92400e; font-size: 14px;">days</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Quick Presets -->
                                    <div style="margin-top: 12px;">
                                        <span style="color: #64748b; font-size: 12px; display: block; margin-bottom: 8px;">Quick presets:</span>
                                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                            <button type="button" onclick="setRecurringPreset(1, 'hours', 7, 'days')" class="preset-btn" style="padding: 8px 14px; border: 2px solid #10b981; background: #ecfdf5; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; color: #059669;">üî• Every hour for 7 days</button>
                                            <button type="button" onclick="setRecurringPreset(1, 'days', 0, 'forever')" class="preset-btn" style="padding: 6px 12px; border: 1px solid #d1d5db; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 12px;">Daily forever</button>
                                            <button type="button" onclick="setRecurringPreset(12, 'hours', 30, 'days')" class="preset-btn" style="padding: 6px 12px; border: 1px solid #d1d5db; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 12px;">Twice daily for 30 days</button>
                                            <button type="button" onclick="setRecurringPreset(1, 'weeks', 0, 'forever')" class="preset-btn" style="padding: 6px 12px; border: 1px solid #d1d5db; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 12px;">Weekly forever</button>
                                        </div>
                                    </div>
                                    
                                    <!-- Summary -->
                                    <div id="recurringSummary" style="margin-top: 16px; padding: 12px 16px; background: linear-gradient(135deg, #dbeafe, #e0e7ff); border-radius: 10px; display: none;">
                                        <span style="color: #3730a3; font-size: 13px; font-weight: 500;" id="recurringSummaryText">üìä Summary will appear here</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <style>
                        .quick-schedule-btn:hover {
                            background: #6366f1 !important;
                            color: white !important;
                            border-color: #6366f1 !important;
                            transform: translateY(-1px);
                        }
                        .quick-schedule-btn.active {
                            background: #6366f1 !important;
                            color: white !important;
                            border-color: #6366f1 !important;
                        }
                        .preset-btn:hover {
                            background: #e0e7ff !important;
                            border-color: #6366f1 !important;
                        }
                        #scheduleTime:focus {
                            outline: none;
                            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
                        }
                    </style>
                    
                    <div class="target-groups">
                        <h4 style="display: flex; align-items: center; gap: 10px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px;">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            Post to Groups/Pages
                            <span id="selectedCount" style="background: #1877f2; color: white; padding: 2px 8px; border-radius: 20px; font-size: 12px; font-weight: bold;">0</span>
                        </h4>
                        
                        <div id="groupsList" class="groups-selector">
                            <div class="loading">Loading your groups...</div>
                        </div>
                        
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e5e5;">
                            <button type="button" class="btn btn-outline" onclick="selectAllGroups()" style="margin-right: 8px; font-size: 13px;">
                                ‚úì Select All
                            </button>
                            <button type="button" class="btn btn-outline" onclick="deselectAllGroups()" style="font-size: 13px;">
                                ‚úï Deselect All
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="previewPost()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            Preview
                        </button>
                        <button type="submit" class="btn btn-primary" id="postBtn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                            Post to All Groups
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="post-preview">
                <h3>Preview</h3>
                <div class="preview-card">
                    <div class="preview-header">
                        <div class="preview-avatar"></div>
                        <div>
                            <strong>Your Name</strong>
                            <p class="text-muted">Just now</p>
                        </div>
                    </div>
                    <div class="preview-content" id="previewContent">
                        <p class="text-muted">Your post content will appear here...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
let groups = [];
let selectedMedia = [];

function toggleSchedule() {
    const checkbox = document.getElementById('schedulePost');
    const options = document.getElementById('scheduleOptions');
    const label = document.getElementById('nextRunLabel');
    
    if (checkbox.checked) {
        options.style.display = 'block';
        label.style.display = 'inline-flex';
        // Set minimum datetime to now
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('scheduleTime').min = now.toISOString().slice(0, 16);
    } else {
        options.style.display = 'none';
        label.style.display = 'none';
    }
}

function toggleRecurring() {
    const checkbox = document.getElementById('recurring');
    const options = document.getElementById('recurringOptions');
    options.style.display = checkbox.checked ? 'block' : 'none';
    updateRecurringSummary();
}

function setQuickSchedule(preset) {
    const now = new Date();
    let target;
    
    // Clear active state from all quick buttons
    document.querySelectorAll('.quick-schedule-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    switch(preset) {
        case '30m':
            target = new Date(now.getTime() + 30 * 60000);
            break;
        case '1h':
            target = new Date(now.getTime() + 60 * 60000);
            break;
        case '3h':
            target = new Date(now.getTime() + 3 * 60 * 60000);
            break;
        case 'tomorrow':
            target = new Date(now);
            target.setDate(target.getDate() + 1);
            target.setHours(9, 0, 0, 0);
            break;
        default:
            return;
    }
    
    // Format for datetime-local input
    const formatted = target.toISOString().slice(0, 16);
    document.getElementById('scheduleTime').value = formatted;
    previewNextRun();
}

function setRecurringPreset(value, unit, durationVal = 0, durationType = 'forever') {
    document.getElementById('intervalHours').value = value;
    document.getElementById('intervalUnit').value = unit;
    document.getElementById('durationType').value = durationType;
    
    if (durationType !== 'forever' && durationVal > 0) {
        document.getElementById('durationValue').value = durationVal;
    }
    
    toggleDurationInput();
    updateRecurringSummary();
    
    // Visual feedback
    document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.style.background = '#f9fafb';
        btn.style.borderColor = '#d1d5db';
    });
    event.target.style.background = '#e0e7ff';
    event.target.style.borderColor = '#6366f1';
}

function toggleDurationInput() {
    const durationType = document.getElementById('durationType').value;
    const container = document.getElementById('durationValueContainer');
    const label = document.getElementById('durationLabel');
    
    if (durationType === 'forever') {
        container.style.display = 'none';
    } else {
        container.style.display = 'flex';
        label.textContent = durationType === 'days' ? 'days' : 'times';
    }
    
    updateRecurringSummary();
}

function updateRecurringSummary() {
    const summaryEl = document.getElementById('recurringSummary');
    const summaryText = document.getElementById('recurringSummaryText');
    
    if (!document.getElementById('recurring').checked) {
        summaryEl.style.display = 'none';
        return;
    }
    
    const intervalVal = parseInt(document.getElementById('intervalHours').value) || 1;
    const intervalUnit = document.getElementById('intervalUnit').value;
    const durationType = document.getElementById('durationType').value;
    const durationVal = parseInt(document.getElementById('durationValue').value) || 7;
    
    let intervalText = `every ${intervalVal} ${intervalUnit}`;
    if (intervalVal === 1) {
        intervalText = `every ${intervalUnit.slice(0, -1)}`; // Remove 's' for singular
    }
    
    let durationText = '';
    let totalPosts = 0;
    
    if (durationType === 'forever') {
        durationText = 'forever (until stopped)';
        totalPosts = '‚àû';
    } else if (durationType === 'days') {
        durationText = `for ${durationVal} days`;
        // Calculate total posts
        const intervalHours = getIntervalInHours();
        totalPosts = Math.floor((durationVal * 24) / intervalHours);
    } else if (durationType === 'times') {
        durationText = `${durationVal} times total`;
        totalPosts = durationVal;
    }
    
    summaryText.innerHTML = `üìä Post ${intervalText} ${durationText} <strong style="color: #1e40af;">(~${totalPosts} posts)</strong>`;
    summaryEl.style.display = 'block';
}

function getIntervalInHours() {
    const value = parseInt(document.getElementById('intervalHours').value) || 1;
    const unit = document.getElementById('intervalUnit').value;
    
    switch(unit) {
        case 'hours': return value;
        case 'days': return value * 24;
        case 'weeks': return value * 24 * 7;
        default: return value;
    }
}

function getDurationData() {
    const durationType = document.getElementById('durationType').value;
    const durationVal = parseInt(document.getElementById('durationValue').value) || 7;
    
    if (durationType === 'forever') {
        return { type: 'forever', value: 0 };
    } else if (durationType === 'days') {
        return { type: 'days', value: durationVal };
    } else {
        return { type: 'times', value: durationVal };
    }
}

function previewMedia(event) {
    const files = Array.from(event.target.files);
    selectedMedia = files;
    
    const container = document.getElementById('mediaPreview');
    container.innerHTML = '';
    
    files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const isVideo = file.type.startsWith('video/');
            const preview = document.createElement('div');
            preview.style.cssText = 'position: relative; display: inline-block;';
            
            if (isVideo) {
                preview.innerHTML = `
                    <video src="${e.target.result}" style="max-width: 150px; max-height: 150px; border-radius: 8px;" controls></video>
                    <button onclick="removeMedia(${index})" style="position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">‚úï</button>
                `;
            } else {
                preview.innerHTML = `
                    <img src="${e.target.result}" style="max-width: 150px; max-height: 150px; border-radius: 8px; object-fit: cover;">
                    <button onclick="removeMedia(${index})" style="position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">‚úï</button>
                `;
            }
            container.appendChild(preview);
        }
        reader.readAsDataURL(file);
    });
    
    document.getElementById('clearMediaBtn').style.display = files.length > 0 ? 'block' : 'none';
}

function removeMedia(index) {
    selectedMedia.splice(index, 1);
    const dt = new DataTransfer();
    selectedMedia.forEach(file => dt.items.add(file));
    document.getElementById('postMedia').files = dt.files;
    previewMedia({target: {files: dt.files}});
}

function clearAllMedia() {
    selectedMedia = [];
    document.getElementById('postMedia').value = '';
    document.getElementById('mediaPreview').innerHTML = '';
    document.getElementById('clearMediaBtn').style.display = 'none';
}

async function previewSpintax() {
    const content = textarea.value;
    if (!content.includes('{')) {
        alert('No spintax found in your content. Use {option1|option2} syntax.');
        return;
    }
    
    try {
        const response = await fetch('/api/spintax-preview', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ content })
        });
        const data = await response.json();
        if (data.success) {
            alert('5 Variations:\\n\\n' + data.variations.join('\\n\\n---\\n\\n'));
        }
    } catch (error) {
        console.error(error);
    }
}

function previewNextRun() {
    const raw = document.getElementById('scheduleTime').value.trim();
    const label = document.getElementById('nextRunLabel');
    const preview = document.getElementById('schedulePreview');
    const previewText = document.getElementById('schedulePreviewText');
    
    if (!raw) { 
        label.innerHTML = '‚è∞ Next: ‚Äî'; 
        preview.style.display = 'none';
        return; 
    }
    
    try {
        const target = new Date(raw);
        const diffMs = target.getTime() - Date.now();
        
        if (diffMs <= 0) { 
            label.innerHTML = '‚ö†Ô∏è Time passed!';
            label.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
            preview.style.display = 'none';
            return; 
        }
        
        label.style.background = 'linear-gradient(135deg, #6366f1, #8b5cf6)';
        
        const mins = Math.floor(diffMs / 60000);
        const hrs = Math.floor(mins / 60);
        const days = Math.floor(hrs / 24);
        const remHrs = hrs % 24;
        const remMins = mins % 60;
        
        let relativeText;
        if (days > 0) {
            relativeText = `in ${days}d ${remHrs}h`;
        } else if (hrs > 0) {
            relativeText = `in ${hrs}h ${remMins}m`;
        } else {
            relativeText = `in ${mins} min`;
        }
        
        label.innerHTML = `‚è∞ ${relativeText}`;
        
        // Show detailed preview
        const options = { 
            weekday: 'short', 
            month: 'short', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
        };
        const formattedDate = target.toLocaleDateString('en-US', options);
        previewText.textContent = `Your post will be published on ${formattedDate}`;
        preview.style.display = 'block';
        
    } catch (_) {
        label.innerHTML = '‚è∞ Next: ‚Äî';
        preview.style.display = 'none';
    }
}

async function loadGroups() {
    try {
        const response = await fetch('/api/groups');
        const data = await response.json();
        
        if (data.success) {
            groups = data.groups.filter(g => g.status === 'straight');
            
            const container = document.getElementById('groupsList');
            if (groups.length === 0) {
                container.innerHTML = '<p class="text-muted" style="padding: 20px; text-align: center;">No active groups. <a href="/groups">Add groups</a> first.</p>';
            } else {
                container.innerHTML = `
                    <div class="groups-grid">
                        ${groups.map((g, idx) => `
                            <label class="group-checkbox">
                                <input type="checkbox" value="${g.username}" onchange="updateGroupCount()" checked style="margin-right: 10px; cursor: pointer;">
                                <span class="checkbox-custom"></span>
                                <div class="group-info">
                                    <strong>${escapeHtml(g.name)}</strong>
                                    <small style="color: #65676b; display: block; margin-top: 3px;">
                                        ${g.type || 'group'} ‚Ä¢ ${g.status}
                                    </small>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                `;
                updateGroupCount();
            }
        }
    } catch (error) {
        console.error('Failed to load groups:', error);
        document.getElementById('groupsList').innerHTML = '<p class="error" style="padding: 20px; text-align: center;">Failed to load groups</p>';
    }
}

function updateGroupCount() {
    const checked = document.querySelectorAll('.group-checkbox input:checked').length;
    document.getElementById('selectedCount').textContent = checked;
}

function selectAllGroups() {
    document.querySelectorAll('.group-checkbox input').forEach(cb => cb.checked = true);
    updateGroupCount();
}

function deselectAllGroups() {
    document.querySelectorAll('.group-checkbox input').forEach(cb => cb.checked = false);
    updateGroupCount();
}

const textarea = document.getElementById('postContent');
const charCount = document.getElementById('charCount');
const previewContent = document.getElementById('previewContent');

textarea.addEventListener('input', () => {
    const count = textarea.value.length;
    charCount.textContent = count;
    updatePreview();
});

function updatePreview() {
    const content = textarea.value;
    if (content.trim()) {
        previewContent.innerHTML = escapeHtml(content).replace(/\n/g, '<br>');
    } else {
        previewContent.innerHTML = '<p class="text-muted">Your post content will appear here...</p>';
    }
}

function previewPost() {
    updatePreview();
    document.querySelector('.post-preview').scrollIntoView({ behavior: 'smooth' });
}

document.getElementById('postForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const content = textarea.value.trim();
    if (!content) {
        alert('Please enter post content');
        return;
    }
    
    if (groups.length === 0) {
        alert('No active groups found. Please add groups first.');
        return;
    }
    
    const schedulePost = document.getElementById('schedulePost').checked;
    
    if (schedulePost) {
        // Schedule the post
        const scheduleTime = document.getElementById('scheduleTime').value;
        if (!scheduleTime) {
            alert('Please select a schedule time');
            return;
        }
        
        const btn = document.getElementById('postBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Scheduling...';
        
        try {
            const duration = getDurationData();
            const response = await fbAutoPoster.csrfFetch('/api/schedule', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    content,
                    groups: groups.map(g => g.username),
                    schedule_time: scheduleTime,
                    recurring: document.getElementById('recurring').checked,
                    interval_hours: getIntervalInHours(),
                    duration_type: duration.type,
                    duration_value: duration.value
                })
            });
            
            const data = await response.json();
            if (data.success) {
                const intervalHours = getIntervalInHours();
                let msg = 'Post scheduled successfully!';
                if (document.getElementById('recurring').checked) {
                    if (duration.type === 'days') {
                        const totalPosts = Math.floor((duration.value * 24) / intervalHours);
                        msg = `Recurring post scheduled! ~${totalPosts} posts over ${duration.value} days`;
                    } else if (duration.type === 'times') {
                        msg = `Recurring post scheduled! Will post ${duration.value} times`;
                    } else {
                        msg = 'Recurring post scheduled! Will run until stopped';
                    }
                }
                fbAutoPoster.showNotification(msg, 'success');
                textarea.value = '';
                updatePreview();
                previewNextRun();
            } else {
                fbAutoPoster.showNotification('Failed to schedule: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            fbAutoPoster.showNotification('Error: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Post to All Groups';
        }
        return;
    }
    
    // Post with media if selected
    if (selectedMedia.length > 0) {
        const formData = new FormData();
        formData.append('content', content);
        selectedMedia.forEach(file => {
            formData.append('media', file);
        });
        formData.append('groups', JSON.stringify([]));
        
        const btn = document.getElementById('postBtn');
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner"></span> Posting with ${selectedMedia.length} media file(s)...`;
        
        try {
            const response = await fbAutoPoster.csrfFetch('/api/post-with-image', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                alert(`Posted successfully to ${data.posted_to} groups!`);
                textarea.value = '';
                clearAllMedia();
                updatePreview();
            } else {
                alert('Failed: ' + data.error);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Post to All Groups';
        }
        return;
    }
    
    // Regular post
    if (!confirm(`Post this content to ${groups.length} group(s)?`)) {
        return;
    }
    
    const btn = document.getElementById('postBtn');
    btn.disabled = true;
    btn.innerHTML = `
        <span class="spinner"></span>
        Posting...
    `;
    
    try {
        // Use FormData to send both text and files
        const formData = new FormData();
        formData.append('content', content);
        
        // Add selected groups
        groups.forEach(g => formData.append('groups[]', g));
        
        // Add media files if any
        const mediaInput = document.getElementById('postMedia');
        if (mediaInput.files && mediaInput.files.length > 0) {
            for (let i = 0; i < mediaInput.files.length; i++) {
                formData.append('media', mediaInput.files[i]);
            }
        }
        
        const response = await fbAutoPoster.csrfFetch('/api/post', {
            method: 'POST',
            body: formData  // Don't set Content-Type header, browser will set it automatically with boundary
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Post created successfully! Check History for details.');
            textarea.value = '';
            updatePreview();
            charCount.textContent = '0';
        } else {
            alert('Failed to create post: ' + data.error);
        }
    } catch (error) {
        alert('Error creating post: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
            Post to All Groups
        `;
    }
});

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

loadGroups();
</script>
{% endblock %}
