{% extends "base.html" %}

{% block title %}Cr√©er une Publication - {{ app_name|default('FB Auto Poster') }}{% endblock %}

{% block body %}
<div class="dashboard">
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()" aria-label="Toggle menu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>
    
    <!-- Sidebar Overlay (for mobile) -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <nav class="sidebar">
        <div class="sidebar-header">
            <svg class="logo-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
            <span>{{ app_name|default('FB Auto Poster') }}</span>
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="/dashboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Tableau de Bord
                </a>
            </li>
            <li class="nav-item">
                <a href="/groups">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    G√©rer les Groupes
                </a>
            </li>
            <li class="nav-item active">
                <a href="/post">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    Cr√©er une Publication
                </a>
            </li>
            <li class="nav-item">
                <a href="/history">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                        <polyline points="17 6 23 6 23 12"></polyline>
                    </svg>
                    Historique
                </a>
            </li>
            <li class="nav-item">
                <a href="/templates">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    Scripts Pr√™ts
                </a>
            </li>
            <li class="nav-item">
                <a href="/accounts">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    Comptes
                </a>
            </li>
        </ul>
        
        <div class="sidebar-footer">
            <a href="/logout" class="btn-logout">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                D√©connexion
            </a>
        </div>
    </nav>
    
    <main class="main-content">
        <header class="content-header">
            <h2>Cr√©er une Nouvelle Publication</h2>
        </header>
        
        <!-- Template Quick Actions Bar -->
        <div class="template-bar" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 16px 20px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 16px; flex-wrap: wrap; border: 1px solid #dee2e6;">
            <div style="display: flex; align-items: center; gap: 10px; flex: 1; min-width: 250px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6c757d" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
                <select id="templateSelect" onchange="loadSelectedTemplate()" style="flex: 1; padding: 10px 14px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                    <option value="">üìÅ Charger un Script Pr√™t...</option>
                </select>
            </div>
            <button type="button" onclick="saveAsTemplate()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                Sauvegarder comme Script
            </button>
            <a href="/templates" style="padding: 10px 20px; background: #f8f9fa; color: #495057; border: 2px solid #dee2e6; border-radius: 8px; text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 8px; transition: all 0.2s;" onmouseover="this.style.borderColor='#1877f2';this.style.color='#1877f2'" onmouseout="this.style.borderColor='#dee2e6';this.style.color='#495057'">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33"></path>
                </svg>
                G√©rer Scripts
            </a>
        </div>
        
        <div class="post-creator">
            <div class="post-form-container">
                <form id="postForm">
                    <div class="form-group">
                        <label for="postContent">Contenu de la Publication * 
                            <span class="badge" style="background: #1877f2; color: white; margin-left: 10px;">NOUVEAU : Spintax Support√© !</span>
                        </label>
                        <textarea id="postContent" rows="10" required placeholder="√âcrivez le contenu de votre publication ici...

‚ú® NOUVELLES FONCTIONNALIT√âS :
- Spintax : {Bonjour|Salut|Hey} pour des variations uniques
- Ajoutez des images (voir ci-dessous)
- Planifiez pour plus tard

Exemple : {Salut|Bonjour} tout le monde ! D√©couvrez notre {incroyable|superbe} {nouveau|dernier} produit !"></textarea>
                        <div class="char-count">
                            <span id="charCount">0</span> caract√®res
                            <button type="button" onclick="previewSpintax()" class="btn-link" style="margin-left: 15px;">
                                üîÑ Aper√ßu des Variations
                            </button>
                        </div>
                    </div>
                    
                    <!-- MEDIA SECTION - Upload or Select from Library -->
                    <div class="form-group" style="border: 2px dashed #1877f2; padding: 24px; border-radius: 12px; background: linear-gradient(135deg, #f0f8ff 0%, #e8f4fd 100%);">
                        <label style="font-weight: 600; font-size: 15px; display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <span style="font-size: 24px;">üì∏üé•</span>
                            Ajouter des M√©dias (Images/Vid√©os)
                        </label>
                        
                        <!-- Two options: Upload or Select from Library -->
                        <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                            <button type="button" onclick="document.getElementById('postMedia').click()" style="flex: 1; min-width: 200px; padding: 16px 20px; background: white; border: 2px solid #1877f2; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: 600; color: #1877f2; transition: all 0.2s;" onmouseover="this.style.background='#e8f4fd'" onmouseout="this.style.background='white'">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                Importer un Fichier
                            </button>
                            <button type="button" onclick="openMediaLibrary()" style="flex: 1; min-width: 200px; padding: 16px 20px; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: 600; color: white; transition: all 0.2s; box-shadow: 0 2px 8px rgba(16,185,129,0.3);" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                                Choisir de la Biblioth√®que
                            </button>
                        </div>
                        
                        <input type="file" id="postMedia" accept="image/jpeg,image/png,image/gif,image/webp,video/mp4,video/quicktime,video/webm,video/x-msvideo,.jpg,.jpeg,.png,.gif,.webp,.mp4,.mov,.webm,.avi" multiple onchange="previewMedia(event)" style="display: none;">
                        
                        <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;">
                            <span style="background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">‚úì JPG</span>
                            <span style="background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">‚úì PNG</span>
                            <span style="background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">‚úì GIF</span>
                            <span style="background: #e3f2fd; color: #1565c0; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">‚úì MP4</span>
                            <span style="background: #e3f2fd; color: #1565c0; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">‚úì MOV</span>
                            <span style="background: #e3f2fd; color: #1565c0; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500;">‚úì WEBM</span>
                        </div>
                        
                        <!-- Selected Media Preview -->
                        <div id="mediaPreview" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px;">
                            <!-- Media previews will appear here -->
                        </div>
                        <div id="libraryMediaPreview" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px;">
                            <!-- Library media previews will appear here -->
                        </div>
                        <button type="button" onclick="clearAllMedia()" style="margin-top: 12px; padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; display: none; font-weight: 500;" id="clearMediaBtn">üóëÔ∏è Tout Effacer</button>
                    </div>
                    
                    <!-- TEST MODE Section -->
                    <div class="form-group" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 16px; border: 2px solid #f59e0b;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <label style="font-weight:600; font-size: 15px; display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="testMode" onchange="toggleTestMode()" style="width: 20px; height: 20px; accent-color: #f59e0b;"> 
                                <span style="display: flex; align-items: center; gap: 8px;">
                                    üß™ <span>Mode Test (Simulation)</span>
                                </span>
                            </label>
                            <span class="badge" style="background: #f59e0b; color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px;">SANS PUBLICATION R√âELLE</span>
                        </div>
                        <div id="testModeInfo" style="margin-top: 12px; padding: 12px; background: white; border-radius: 8px; display: none;">
                            <p style="margin: 0; font-size: 13px; color: #92400e;">
                                ‚ö†Ô∏è <strong>Mode Test activ√© :</strong> Le bot naviguera vers chaque groupe, remplira le texte et les m√©dias, mais <strong>ne cliquera PAS</strong> sur le bouton Publier. Des captures d'√©cran seront enregistr√©es pour v√©rification.
                            </p>
                        </div>
                    </div>
                    
                    <!-- DELAY CONFIGURATION Section -->
                    <div class="form-group" style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); padding: 20px; border-radius: 16px; border: 2px solid #10b981;">
                        <label style="font-weight:600; font-size: 15px; display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                            <span style="font-size: 20px;">‚è±Ô∏è</span>
                            D√©lai entre les Publications
                            <span class="badge" style="background: #10b981; color: white; padding: 4px 10px; border-radius: 20px; font-size: 11px;">CONFIGURABLE</span>
                        </label>
                        
                        <!-- Speed Presets -->
                        <div style="display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap;">
                            <button type="button" onclick="setSpeedPreset('fast')" class="speed-btn" id="speedFast" style="flex: 1; min-width: 100px; padding: 10px; border: 2px solid #f59e0b; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 10px; cursor: pointer; font-weight: 600; color: #b45309;">
                                ‚ö° Rapide<br><small style="font-weight: normal;">5-15s</small>
                            </button>
                            <button type="button" onclick="setSpeedPreset('normal')" class="speed-btn active" id="speedNormal" style="flex: 1; min-width: 100px; padding: 10px; border: 2px solid #10b981; background: linear-gradient(135deg, #d1fae5, #a7f3d0); border-radius: 10px; cursor: pointer; font-weight: 600; color: #065f46;">
                                üöÄ Normal<br><small style="font-weight: normal;">30-120s</small>
                            </button>
                            <button type="button" onclick="setSpeedPreset('safe')" class="speed-btn" id="speedSafe" style="flex: 1; min-width: 100px; padding: 10px; border: 2px solid #3b82f6; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 10px; cursor: pointer; font-weight: 600; color: #1e40af;">
                                üõ°Ô∏è S√©curis√©<br><small style="font-weight: normal;">120-300s</small>
                            </button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label style="display: block; font-size: 13px; color: #065f46; margin-bottom: 8px; font-weight: 500;">
                                    D√©lai Minimum: <strong id="minDelayValue">30</strong> secondes
                                </label>
                                <input type="range" id="minDelay" min="5" max="300" value="30" 
                                    style="width: 100%; accent-color: #10b981;" 
                                    oninput="updateDelayValue('min')">
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; color: #065f46; margin-bottom: 8px; font-weight: 500;">
                                    D√©lai Maximum: <strong id="maxDelayValue">120</strong> secondes
                                </label>
                                <input type="range" id="maxDelay" min="10" max="600" value="120" 
                                    style="width: 100%; accent-color: #10b981;" 
                                    oninput="updateDelayValue('max')">
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: white; border-radius: 8px;">
                            <p style="margin: 0; font-size: 12px; color: #065f46;">
                                ‚ö†Ô∏è <strong>Attention :</strong> Le mode Rapide augmente le risque de d√©tection par Facebook. Utilisez-le avec pr√©caution.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Improved Schedule Section -->
                    <div class="form-group schedule-section" style="background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%); padding: 20px; border-radius: 16px; border: 2px solid #e0e7ff;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 12px;">
                            <label style="font-weight:600; font-size: 15px; display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="schedulePost" onchange="toggleSchedule()" style="width: 20px; height: 20px; accent-color: #6366f1;"> 
                                <span style="display: flex; align-items: center; gap: 8px;">
                                    üìÖ <span>Planifier cette Publication</span>
                                </span>
                            </label>
                            <span id="nextRunLabel" class="schedule-badge" style="display:none; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; box-shadow: 0 2px 8px rgba(99,102,241,0.3);">
                                ‚è∞ Prochain : ‚Äî
                            </span>
                        </div>
                        
                        <div id="scheduleOptions" style="display: none; margin-top: 16px;">
                            <!-- Quick Schedule Buttons -->
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;">
                                <button type="button" class="quick-schedule-btn" onclick="setQuickSchedule('30m')" style="padding: 8px 16px; border: 2px solid #e0e7ff; background: white; border-radius: 20px; cursor: pointer; font-size: 13px; transition: all 0.2s;">‚ö° Dans 30 min</button>
                                <button type="button" class="quick-schedule-btn" onclick="setQuickSchedule('1h')" style="padding: 8px 16px; border: 2px solid #e0e7ff; background: white; border-radius: 20px; cursor: pointer; font-size: 13px; transition: all 0.2s;">üïê Dans 1 heure</button>
                                <button type="button" class="quick-schedule-btn" onclick="setQuickSchedule('3h')" style="padding: 8px 16px; border: 2px solid #e0e7ff; background: white; border-radius: 20px; cursor: pointer; font-size: 13px; transition: all 0.2s;">üïí Dans 3 heures</button>
                                <button type="button" class="quick-schedule-btn" onclick="setQuickSchedule('tomorrow')" style="padding: 8px 16px; border: 2px solid #e0e7ff; background: white; border-radius: 20px; cursor: pointer; font-size: 13px; transition: all 0.2s;">üåÖ Demain 9h</button>
                            </div>
                            
                            <!-- Date/Time Picker -->
                            <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid #e5e7eb; margin-bottom: 16px;">
                                <label style="display: block; font-size: 13px; color: #64748b; margin-bottom: 8px; font-weight: 500;">üìÜ Choisir la date et l'heure exactes</label>
                                <input type="datetime-local" id="scheduleTime" onchange="previewNextRun()" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: border-color 0.2s;" onfocus="this.style.borderColor='#6366f1'" onblur="this.style.borderColor='#e5e7eb'">
                                <div id="schedulePreview" style="margin-top: 10px; padding: 10px; background: #f0fdf4; border-radius: 8px; display: none;">
                                    <span style="color: #15803d; font-size: 13px;">‚úì <span id="schedulePreviewText"></span></span>
                                </div>
                            </div>
                            
                            <!-- Recurring Options -->
                            <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid #e5e7eb;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 12px;">
                                    <input type="checkbox" id="recurring" onchange="toggleRecurring()" style="width: 18px; height: 18px; accent-color: #6366f1;">
                                    <span style="font-weight: 500;">üîÑ Rendre cette publication r√©currente</span>
                                </label>
                                
                                <div id="recurringOptions" style="display: none; padding-left: 28px;">
                                    <!-- Interval Setting -->
                                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 16px;">
                                        <span style="color: #64748b; font-size: 14px;">R√©p√©ter toutes les</span>
                                        <input type="number" id="intervalHours" min="1" value="1" style="width: 70px; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; text-align: center; font-size: 14px;">
                                        <select id="intervalUnit" style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: white;">
                                            <option value="hours" selected>Heures</option>
                                            <option value="days">Jours</option>
                                            <option value="weeks">Semaines</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Duration Setting -->
                                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; padding: 14px; background: #fef3c7; border-radius: 10px; border: 1px solid #fcd34d;">
                                        <span style="color: #92400e; font-size: 14px; font-weight: 500;">‚è±Ô∏è Dur√©e :</span>
                                        <select id="durationType" onchange="toggleDurationInput()" style="padding: 8px 12px; border: 2px solid #fcd34d; border-radius: 8px; font-size: 14px; background: white;">
                                            <option value="forever">Ind√©finiment</option>
                                            <option value="days">Pendant X jours</option>
                                            <option value="times">X fois</option>
                                        </select>
                                        <div id="durationValueContainer" style="display: none; align-items: center; gap: 8px;">
                                            <input type="number" id="durationValue" min="1" value="7" style="width: 70px; padding: 8px 12px; border: 2px solid #fcd34d; border-radius: 8px; text-align: center; font-size: 14px;">
                                            <span id="durationLabel" style="color: #92400e; font-size: 14px;">jours</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Quick Presets -->
                                    <div style="margin-top: 12px;">
                                        <span style="color: #64748b; font-size: 12px; display: block; margin-bottom: 8px;">Pr√©r√©glages rapides :</span>
                                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                            <button type="button" onclick="setRecurringPreset(1, 'hours', 7, 'days')" class="preset-btn" style="padding: 8px 14px; border: 2px solid #10b981; background: #ecfdf5; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; color: #059669;">üî• Toutes les heures pendant 7 jours</button>
                                            <button type="button" onclick="setRecurringPreset(1, 'days', 0, 'forever')" class="preset-btn" style="padding: 6px 12px; border: 1px solid #d1d5db; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 12px;">Quotidien ind√©finiment</button>
                                            <button type="button" onclick="setRecurringPreset(12, 'hours', 30, 'days')" class="preset-btn" style="padding: 6px 12px; border: 1px solid #d1d5db; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 12px;">2x par jour pendant 30 jours</button>
                                            <button type="button" onclick="setRecurringPreset(1, 'weeks', 0, 'forever')" class="preset-btn" style="padding: 6px 12px; border: 1px solid #d1d5db; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 12px;">Hebdomadaire ind√©finiment</button>
                                        </div>
                                    </div>
                                    
                                    <!-- Summary -->
                                    <div id="recurringSummary" style="margin-top: 16px; padding: 12px 16px; background: linear-gradient(135deg, #dbeafe, #e0e7ff); border-radius: 10px; display: none;">
                                        <span style="color: #3730a3; font-size: 13px; font-weight: 500;" id="recurringSummaryText">üìä Le r√©sum√© appara√Ætra ici</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <style>
                        .quick-schedule-btn:hover {
                            background: #6366f1 !important;
                            color: white !important;
                            border-color: #6366f1 !important;
                            transform: translateY(-1px);
                        }
                        .quick-schedule-btn.active {
                            background: #6366f1 !important;
                            color: white !important;
                            border-color: #6366f1 !important;
                        }
                        .preset-btn:hover {
                            background: #e0e7ff !important;
                            border-color: #6366f1 !important;
                        }
                        #scheduleTime:focus {
                            outline: none;
                            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
                        }
                    </style>
                    
                    <div class="target-groups">
                        <h4 style="display: flex; align-items: center; gap: 10px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px;">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            Publier dans les Groupes/Pages
                            <span id="selectedCount" style="background: #1877f2; color: white; padding: 2px 8px; border-radius: 20px; font-size: 12px; font-weight: bold;">0</span>
                        </h4>
                        
                        <div id="groupsList" class="groups-selector">
                            <div class="loading">Chargement de vos groupes...</div>
                        </div>
                        
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e5e5;">
                            <button type="button" class="btn btn-outline" onclick="selectAllGroups()" style="margin-right: 8px; font-size: 13px;">
                                ‚úì Tout S√©lectionner
                            </button>
                            <button type="button" class="btn btn-outline" onclick="deselectAllGroups()" style="font-size: 13px;">
                                ‚úï Tout D√©s√©lectionner
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="previewPost()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            Aper√ßu
                        </button>
                        <button type="submit" class="btn btn-primary" id="postBtn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                            Publier dans Tous les Groupes
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="post-preview">
                <h3>Aper√ßu</h3>
                <div class="preview-card">
                    <div class="preview-header">
                        <div class="preview-avatar"></div>
                        <div>
                            <strong>Votre Nom</strong>
                            <p class="text-muted">√Ä l'instant</p>
                        </div>
                    </div>
                    <div class="preview-content" id="previewContent">
                        <p class="text-muted">Le contenu de votre publication appara√Ætra ici...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Media Library Selection Modal -->
<div id="mediaLibraryModal" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width:800px;max-height:80vh;">
        <div class="modal-header">
            <h3>Choisir de la Biblioth√®que M√©dia</h3>
            <button class="modal-close" onclick="closeMediaLibraryModal()">&times;</button>
        </div>
        <div class="modal-body" style="overflow-y:auto;max-height:60vh;">
            <div id="libraryGrid" class="library-grid">
                <!-- Media items will be loaded here -->
            </div>
        </div>
        <div class="modal-footer">
            <span id="librarySelectionCount" style="flex:1;color:#666;"></span>
            <button class="btn btn-secondary" onclick="closeMediaLibraryModal()">Annuler</button>
            <button class="btn btn-primary" onclick="confirmLibrarySelection()">Confirmer la S√©lection</button>
        </div>
    </div>
</div>

<style>
/* Media Library Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--card-bg, #fff);
    border-radius: 12px;
    width: 90%;
    display: flex;
    flex-direction: column;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border, #eee);
}

.modal-header h3 {
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    display: flex;
    gap: 0.5rem;
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border, #eee);
    align-items: center;
}

.library-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
}

.library-item {
    position: relative;
    aspect-ratio: 1;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.2s;
}

.library-item:hover {
    transform: scale(1.02);
}

.library-item.selected {
    border-color: var(--primary, #1877f2);
}

.library-item img,
.library-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.library-item .item-name {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 0.5rem;
    background: linear-gradient(transparent, rgba(0,0,0,0.7));
    color: #fff;
    font-size: 0.75rem;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
}

.library-item .check-mark {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    width: 24px;
    height: 24px;
    background: var(--primary, #1877f2);
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.library-item .video-badge {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    padding: 0.25rem 0.5rem;
    background: rgba(0,0,0,0.7);
    color: #fff;
    border-radius: 4px;
    font-size: 0.65rem;
    font-weight: bold;
}

/* Library Preview in Post Form */
#libraryMediaPreview {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.library-preview-item {
    position: relative;
    width: 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
}

.library-preview-item img,
.library-preview-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.library-preview-item .remove-btn {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: rgba(220, 53, 69, 0.9);
    color: #fff;
    border: none;
    cursor: pointer;
    font-size: 14px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
}

.library-preview-item .video-badge {
    position: absolute;
    bottom: 2px;
    left: 2px;
    padding: 2px 4px;
    background: rgba(0,0,0,0.7);
    color: #fff;
    border-radius: 3px;
    font-size: 0.6rem;
}
</style>

<script>
let groups = [];
let selectedMedia = [];
let selectedLibraryMedia = [];  // Media selected from library (file IDs)

function toggleTestMode() {
    const checkbox = document.getElementById('testMode');
    const info = document.getElementById('testModeInfo');
    info.style.display = checkbox.checked ? 'block' : 'none';
}

// Speed presets for posting
function setSpeedPreset(preset) {
    const minSlider = document.getElementById('minDelay');
    const maxSlider = document.getElementById('maxDelay');
    
    // Remove active class from all speed buttons
    document.querySelectorAll('.speed-btn').forEach(btn => {
        btn.style.opacity = '0.6';
        btn.style.transform = 'scale(0.95)';
    });
    
    // Set values based on preset
    switch(preset) {
        case 'fast':
            minSlider.value = 5;
            maxSlider.value = 15;
            document.getElementById('speedFast').style.opacity = '1';
            document.getElementById('speedFast').style.transform = 'scale(1)';
            break;
        case 'normal':
            minSlider.value = 30;
            maxSlider.value = 120;
            document.getElementById('speedNormal').style.opacity = '1';
            document.getElementById('speedNormal').style.transform = 'scale(1)';
            break;
        case 'safe':
            minSlider.value = 120;
            maxSlider.value = 300;
            document.getElementById('speedSafe').style.opacity = '1';
            document.getElementById('speedSafe').style.transform = 'scale(1)';
            break;
    }
    
    document.getElementById('minDelayValue').textContent = minSlider.value;
    document.getElementById('maxDelayValue').textContent = maxSlider.value;
}

function updateDelayValue(type) {
    const minSlider = document.getElementById('minDelay');
    const maxSlider = document.getElementById('maxDelay');
    const minValue = parseInt(minSlider.value);
    const maxValue = parseInt(maxSlider.value);
    
    // Ensure min is always less than max
    if (type === 'min' && minValue >= maxValue) {
        maxSlider.value = minValue + 10;
    } else if (type === 'max' && maxValue <= minValue) {
        minSlider.value = Math.max(5, maxValue - 10);
    }
    
    document.getElementById('minDelayValue').textContent = minSlider.value;
    document.getElementById('maxDelayValue').textContent = maxSlider.value;
    
    // Remove active state from presets when manually adjusted
    document.querySelectorAll('.speed-btn').forEach(btn => {
        btn.style.opacity = '0.6';
        btn.style.transform = 'scale(0.95)';
    });
}

function toggleSchedule() {
    const checkbox = document.getElementById('schedulePost');
    const options = document.getElementById('scheduleOptions');
    const label = document.getElementById('nextRunLabel');
    
    if (checkbox.checked) {
        options.style.display = 'block';
        label.style.display = 'inline-flex';
        // Set minimum datetime to now
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('scheduleTime').min = now.toISOString().slice(0, 16);
    } else {
        options.style.display = 'none';
        label.style.display = 'none';
    }
}

function toggleRecurring() {
    const checkbox = document.getElementById('recurring');
    const options = document.getElementById('recurringOptions');
    options.style.display = checkbox.checked ? 'block' : 'none';
    updateRecurringSummary();
}

function setQuickSchedule(preset) {
    const now = new Date();
    let target;
    
    // Clear active state from all quick buttons
    document.querySelectorAll('.quick-schedule-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    switch(preset) {
        case '30m':
            target = new Date(now.getTime() + 30 * 60000);
            break;
        case '1h':
            target = new Date(now.getTime() + 60 * 60000);
            break;
        case '3h':
            target = new Date(now.getTime() + 3 * 60 * 60000);
            break;
        case 'tomorrow':
            target = new Date(now);
            target.setDate(target.getDate() + 1);
            target.setHours(9, 0, 0, 0);
            break;
        default:
            return;
    }
    
    // Format for datetime-local input
    const formatted = target.toISOString().slice(0, 16);
    document.getElementById('scheduleTime').value = formatted;
    previewNextRun();
}

function setRecurringPreset(value, unit, durationVal = 0, durationType = 'forever') {
    document.getElementById('intervalHours').value = value;
    document.getElementById('intervalUnit').value = unit;
    document.getElementById('durationType').value = durationType;
    
    if (durationType !== 'forever' && durationVal > 0) {
        document.getElementById('durationValue').value = durationVal;
    }
    
    toggleDurationInput();
    updateRecurringSummary();
    
    // Visual feedback
    document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.style.background = '#f9fafb';
        btn.style.borderColor = '#d1d5db';
    });
    event.target.style.background = '#e0e7ff';
    event.target.style.borderColor = '#6366f1';
}

function toggleDurationInput() {
    const durationType = document.getElementById('durationType').value;
    const container = document.getElementById('durationValueContainer');
    const label = document.getElementById('durationLabel');
    
    if (durationType === 'forever') {
        container.style.display = 'none';
    } else {
        container.style.display = 'flex';
        label.textContent = durationType === 'days' ? 'days' : 'times';
    }
    
    updateRecurringSummary();
}

function updateRecurringSummary() {
    const summaryEl = document.getElementById('recurringSummary');
    const summaryText = document.getElementById('recurringSummaryText');
    
    if (!document.getElementById('recurring').checked) {
        summaryEl.style.display = 'none';
        return;
    }
    
    const intervalVal = parseInt(document.getElementById('intervalHours').value) || 1;
    const intervalUnit = document.getElementById('intervalUnit').value;
    const durationType = document.getElementById('durationType').value;
    const durationVal = parseInt(document.getElementById('durationValue').value) || 7;
    
    let intervalText = `every ${intervalVal} ${intervalUnit}`;
    if (intervalVal === 1) {
        intervalText = `every ${intervalUnit.slice(0, -1)}`; // Remove 's' for singular
    }
    
    let durationText = '';
    let totalPosts = 0;
    
    if (durationType === 'forever') {
        durationText = 'forever (until stopped)';
        totalPosts = '‚àû';
    } else if (durationType === 'days') {
        durationText = `for ${durationVal} days`;
        // Calculate total posts
        const intervalHours = getIntervalInHours();
        totalPosts = Math.floor((durationVal * 24) / intervalHours);
    } else if (durationType === 'times') {
        durationText = `${durationVal} times total`;
        totalPosts = durationVal;
    }
    
    summaryText.innerHTML = `üìä Post ${intervalText} ${durationText} <strong style="color: #1e40af;">(~${totalPosts} posts)</strong>`;
    summaryEl.style.display = 'block';
}

function getIntervalInHours() {
    const value = parseInt(document.getElementById('intervalHours').value) || 1;
    const unit = document.getElementById('intervalUnit').value;
    
    switch(unit) {
        case 'hours': return value;
        case 'days': return value * 24;
        case 'weeks': return value * 24 * 7;
        default: return value;
    }
}

function getDurationData() {
    const durationType = document.getElementById('durationType').value;
    const durationVal = parseInt(document.getElementById('durationValue').value) || 7;
    
    if (durationType === 'forever') {
        return { type: 'forever', value: 0 };
    } else if (durationType === 'days') {
        return { type: 'days', value: durationVal };
    } else {
        return { type: 'times', value: durationVal };
    }
}

function previewMedia(event) {
    const files = Array.from(event.target.files);
    selectedMedia = files;
    
    const container = document.getElementById('mediaPreview');
    container.innerHTML = '';
    
    files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const isVideo = file.type.startsWith('video/');
            const preview = document.createElement('div');
            preview.style.cssText = 'position: relative; display: inline-block;';
            
            if (isVideo) {
                preview.innerHTML = `
                    <video src="${e.target.result}" style="max-width: 150px; max-height: 150px; border-radius: 8px;" controls></video>
                    <button onclick="removeMedia(${index})" style="position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">‚úï</button>
                `;
            } else {
                preview.innerHTML = `
                    <img src="${e.target.result}" style="max-width: 150px; max-height: 150px; border-radius: 8px; object-fit: cover;">
                    <button onclick="removeMedia(${index})" style="position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">‚úï</button>
                `;
            }
            container.appendChild(preview);
        }
        reader.readAsDataURL(file);
    });
    
    document.getElementById('clearMediaBtn').style.display = files.length > 0 ? 'block' : 'none';
}

function removeMedia(index) {
    selectedMedia.splice(index, 1);
    const dt = new DataTransfer();
    selectedMedia.forEach(file => dt.items.add(file));
    document.getElementById('postMedia').files = dt.files;
    previewMedia({target: {files: dt.files}});
}

function clearAllMedia() {
    selectedMedia = [];
    document.getElementById('postMedia').value = '';
    document.getElementById('mediaPreview').innerHTML = '';
    document.getElementById('clearMediaBtn').style.display = 'none';
}

async function previewSpintax() {
    const content = textarea.value;
    if (!content.includes('{')) {
        alert('No spintax found in your content. Use {option1|option2} syntax.');
        return;
    }
    
    try {
        const response = await fetch('/api/spintax-preview', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ content })
        });
        const data = await response.json();
        if (data.success) {
            alert('5 Variations:\\n\\n' + data.variations.join('\\n\\n---\\n\\n'));
        }
    } catch (error) {
        console.error(error);
    }
}

function previewNextRun() {
    const raw = document.getElementById('scheduleTime').value.trim();
    const label = document.getElementById('nextRunLabel');
    const preview = document.getElementById('schedulePreview');
    const previewText = document.getElementById('schedulePreviewText');
    
    if (!raw) { 
        label.innerHTML = '‚è∞ Next: ‚Äî'; 
        preview.style.display = 'none';
        return; 
    }
    
    try {
        const target = new Date(raw);
        const diffMs = target.getTime() - Date.now();
        
        if (diffMs <= 0) { 
            label.innerHTML = '‚ö†Ô∏è Time passed!';
            label.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
            preview.style.display = 'none';
            return; 
        }
        
        label.style.background = 'linear-gradient(135deg, #6366f1, #8b5cf6)';
        
        const mins = Math.floor(diffMs / 60000);
        const hrs = Math.floor(mins / 60);
        const days = Math.floor(hrs / 24);
        const remHrs = hrs % 24;
        const remMins = mins % 60;
        
        let relativeText;
        if (days > 0) {
            relativeText = `in ${days}d ${remHrs}h`;
        } else if (hrs > 0) {
            relativeText = `in ${hrs}h ${remMins}m`;
        } else {
            relativeText = `in ${mins} min`;
        }
        
        label.innerHTML = `‚è∞ ${relativeText}`;
        
        // Show detailed preview
        const options = { 
            weekday: 'short', 
            month: 'short', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
        };
        const formattedDate = target.toLocaleDateString('en-US', options);
        previewText.textContent = `Your post will be published on ${formattedDate}`;
        preview.style.display = 'block';
        
    } catch (_) {
        label.innerHTML = '‚è∞ Next: ‚Äî';
        preview.style.display = 'none';
    }
}

async function loadGroups() {
    try {
        const response = await fetch('/api/groups');
        const data = await response.json();
        
        if (data.success) {
            // Filter to show ONLY active groups (status = 'straight' or 'active')
            groups = data.groups.filter(g => g.status === 'straight' || g.status === 'active');
            
            const container = document.getElementById('groupsList');
            if (groups.length === 0) {
                container.innerHTML = '<p class="text-muted" style="padding: 20px; text-align: center;">Aucun groupe actif trouv√©. <a href="/groups">Activez des groupes</a> d\'abord.</p>';
            } else {
                container.innerHTML = `
                    <div class="groups-grid">
                        ${groups.map((g, idx) => `
                            <label class="group-checkbox">
                                <input type="checkbox" value="${g.username}" onchange="updateGroupCount()" checked style="margin-right: 10px; cursor: pointer;">
                                <span class="checkbox-custom"></span>
                                <div class="group-info">
                                    <strong>${escapeHtml(g.name)}</strong>
                                    <small style="color: #65676b; display: block; margin-top: 3px;">
                                        ID: ${g.username}
                                    </small>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                `;
                updateGroupCount();
            }
        }
    } catch (error) {
        console.error('Failed to load groups:', error);
        document.getElementById('groupsList').innerHTML = '<p class="error" style="padding: 20px; text-align: center;">√âchec du chargement des groupes</p>';
    }
}

function updateGroupCount() {
    const checked = document.querySelectorAll('.group-checkbox input:checked').length;
    document.getElementById('selectedCount').textContent = checked;
}

function selectAllGroups() {
    document.querySelectorAll('.group-checkbox input').forEach(cb => cb.checked = true);
    updateGroupCount();
}

function deselectAllGroups() {
    document.querySelectorAll('.group-checkbox input').forEach(cb => cb.checked = false);
    updateGroupCount();
}

const textarea = document.getElementById('postContent');
const charCount = document.getElementById('charCount');
const previewContent = document.getElementById('previewContent');

textarea.addEventListener('input', () => {
    const count = textarea.value.length;
    charCount.textContent = count;
    updatePreview();
});

function updatePreview() {
    const content = textarea.value;
    if (content.trim()) {
        previewContent.innerHTML = escapeHtml(content).replace(/\n/g, '<br>');
    } else {
        previewContent.innerHTML = '<p class="text-muted">Your post content will appear here...</p>';
    }
}

function previewPost() {
    updatePreview();
    document.querySelector('.post-preview').scrollIntoView({ behavior: 'smooth' });
}

document.getElementById('postForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const content = textarea.value.trim();
    if (!content) {
        alert('Please enter post content');
        return;
    }
    
    if (groups.length === 0) {
        alert('No active groups found. Please add groups first.');
        return;
    }
    
    const schedulePost = document.getElementById('schedulePost').checked;
    
    if (schedulePost) {
        // Schedule the post
        const scheduleTime = document.getElementById('scheduleTime').value;
        if (!scheduleTime) {
            alert('Please select a schedule time');
            return;
        }
        
        const btn = document.getElementById('postBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Scheduling...';
        
        try {
            const duration = getDurationData();
            // Get selected groups for scheduling
            const scheduleSelectedGroups = [];
            document.querySelectorAll('.group-checkbox input:checked').forEach(cb => {
                scheduleSelectedGroups.push(cb.value);
            });
            
            if (scheduleSelectedGroups.length === 0) {
                alert('Please select at least one group to post to.');
                btn.disabled = false;
                btn.innerHTML = 'Post to All Groups';
                return;
            }
            
            const response = await fbAutoPoster.csrfFetch('/api/schedule', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    content,
                    groups: scheduleSelectedGroups,
                    schedule_time: scheduleTime,
                    recurring: document.getElementById('recurring').checked,
                    interval_hours: getIntervalInHours(),
                    duration_type: duration.type,
                    duration_value: duration.value
                })
            });
            
            const data = await response.json();
            if (data.success) {
                const intervalHours = getIntervalInHours();
                let msg = 'Post scheduled successfully!';
                if (document.getElementById('recurring').checked) {
                    if (duration.type === 'days') {
                        const totalPosts = Math.floor((duration.value * 24) / intervalHours);
                        msg = `Recurring post scheduled! ~${totalPosts} posts over ${duration.value} days`;
                    } else if (duration.type === 'times') {
                        msg = `Recurring post scheduled! Will post ${duration.value} times`;
                    } else {
                        msg = 'Recurring post scheduled! Will run until stopped';
                    }
                }
                fbAutoPoster.showNotification(msg, 'success');
                textarea.value = '';
                updatePreview();
                previewNextRun();
            } else {
                fbAutoPoster.showNotification('Failed to schedule: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            fbAutoPoster.showNotification('Error: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Post to All Groups';
        }
        return;
    }
    
    // Post with media if selected (either uploaded or from library)
    if (selectedMedia.length > 0 || selectedLibraryMedia.length > 0) {
        // Get selected groups for media post
        const mediaSelectedGroups = [];
        document.querySelectorAll('.group-checkbox input:checked').forEach(cb => {
            mediaSelectedGroups.push(cb.value);
        });
        
        if (mediaSelectedGroups.length === 0) {
            alert('Please select at least one group to post to.');
            return;
        }
        
        const formData = new FormData();
        formData.append('content', content);
        selectedMedia.forEach(file => {
            formData.append('media', file);
        });
        // Add library media IDs
        if (selectedLibraryMedia.length > 0) {
            const libraryIds = selectedLibraryMedia.map(m => m.id);
            formData.append('library_media_ids', JSON.stringify(libraryIds));
        }
        formData.append('groups', JSON.stringify(mediaSelectedGroups));
        
        // Add delay and test mode settings
        formData.append('min_delay', document.getElementById('minDelay').value);
        formData.append('max_delay', document.getElementById('maxDelay').value);
        formData.append('test_mode', document.getElementById('testMode').checked ? 'true' : 'false');
        
        const totalMedia = selectedMedia.length + selectedLibraryMedia.length;
        const testModeLabel = document.getElementById('testMode').checked ? ' [MODE TEST]' : '';
        const btn = document.getElementById('postBtn');
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner"></span> Posting to ${mediaSelectedGroups.length} group(s) with ${totalMedia} media file(s)${testModeLabel}...`;
        
        try {
            const response = await fbAutoPoster.csrfFetch('/api/post-with-image', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                alert(`‚úì Publication lanc√©e avec succ√®s !\n\n${data.posted_to} groupe(s) avec ${data.media_count || totalMedia} fichier(s) m√©dia.\n\nV√©rifiez l'historique pour les d√©tails.`);
                textarea.value = '';
                clearAllMedia();
                selectedLibraryMedia = [];
                updateLibraryMediaPreview();
                updatePreview();
            } else {
                alert('Failed: ' + data.error);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Post to All Groups';
        }
        return;
    }
    
    // Regular post
    // Get ONLY the selected groups from checkboxes
    const selectedGroupUsernames = [];
    document.querySelectorAll('.group-checkbox input:checked').forEach(cb => {
        selectedGroupUsernames.push(cb.value);
    });
    
    if (selectedGroupUsernames.length === 0) {
        alert('Please select at least one group to post to.');
        return;
    }
    
    const testModeEnabled = document.getElementById('testMode').checked;
    const confirmMsg = testModeEnabled 
        ? `[MODE TEST] Simuler une publication vers ${selectedGroupUsernames.length} groupe(s) ? (Aucune publication r√©elle)`
        : `Publier ce contenu vers ${selectedGroupUsernames.length} groupe(s) ?`;
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    const testModeLabel = testModeEnabled ? ' [MODE TEST]' : '';
    const btn = document.getElementById('postBtn');
    btn.disabled = true;
    btn.innerHTML = `
        <span class="spinner"></span>
        Posting to ${selectedGroupUsernames.length} group(s)${testModeLabel}...
    `;
    
    try {
        // Use FormData to send both text and files
        const formData = new FormData();
        formData.append('content', content);
        
        // Add ONLY selected groups (by username)
        selectedGroupUsernames.forEach(username => formData.append('groups[]', username));
        
        // Add media files if any
        const mediaInput = document.getElementById('postMedia');
        if (mediaInput.files && mediaInput.files.length > 0) {
            for (let i = 0; i < mediaInput.files.length; i++) {
                formData.append('media', mediaInput.files[i]);
            }
        }
        
        // Add delay and test mode settings
        formData.append('min_delay', document.getElementById('minDelay').value);
        formData.append('max_delay', document.getElementById('maxDelay').value);
        formData.append('test_mode', document.getElementById('testMode').checked ? 'true' : 'false');
        
        const response = await fbAutoPoster.csrfFetch('/api/post', {
            method: 'POST',
            body: formData  // Don't set Content-Type header, browser will set it automatically with boundary
        });
        
        const data = await response.json();
        
        if (data.success) {
            const successMsg = data.test_mode 
                ? 'Simulation termin√©e ! V√©rifiez les captures d\'√©cran dans logs/playwright/test-mode/'
                : 'Publication cr√©√©e ! V√©rifiez l\'historique pour les d√©tails.';
            alert(successMsg);
            textarea.value = '';
            updatePreview();
            charCount.textContent = '0';
        } else {
            alert('Failed to create post: ' + data.error);
        }
    } catch (error) {
        alert('Error creating post: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
            Post to All Groups
        `;
    }
});

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// ===== Media Library Functions =====

async function openMediaLibrary() {
    const modal = document.getElementById('mediaLibraryModal');
    modal.style.display = 'flex';
    await loadLibraryMedia();
}

function closeMediaLibraryModal() {
    document.getElementById('mediaLibraryModal').style.display = 'none';
}

async function loadLibraryMedia() {
    const grid = document.getElementById('libraryGrid');
    grid.innerHTML = '<p style="text-align:center;color:#666;">Chargement...</p>';
    
    try {
        const response = await fbAutoPoster.csrfFetch('/api/media');
        const data = await response.json();
        
        if (data.success && data.files && data.files.length > 0) {
            grid.innerHTML = '';
            data.files.forEach(item => {
                const isSelected = selectedLibraryMedia.some(m => m.id === item.id);
                const div = document.createElement('div');
                div.className = 'library-item' + (isSelected ? ' selected' : '');
                div.dataset.id = item.id;
                
                // Construct URL based on media type
                const subdir = item.media_type === 'image' ? 'images' : 'videos';
                const url = `/media_library/${subdir}/${item.filename}`;
                const itemWithUrl = {...item, url: url, type: item.media_type};
                
                div.onclick = () => toggleLibrarySelection(itemWithUrl);
                
                if (item.media_type === 'image') {
                    div.innerHTML = `
                        <img src="${url}" alt="${item.name}">
                        <span class="item-name">${item.name}</span>
                        ${isSelected ? '<span class="check-mark">‚úì</span>' : ''}
                    `;
                } else {
                    div.innerHTML = `
                        <video src="${url}" muted></video>
                        <span class="item-name">${item.name}</span>
                        <span class="video-badge">VIDEO</span>
                        ${isSelected ? '<span class="check-mark">‚úì</span>' : ''}
                    `;
                }
                grid.appendChild(div);
            });
        } else {
            grid.innerHTML = `
                <p style="text-align:center;color:#666;grid-column:1/-1;">
                    Aucun m√©dia trouv√©.<br>
                    <a href="/media" style="color:var(--primary);">Allez √† la biblioth√®que m√©dia</a> pour en ajouter.
                </p>
            `;
        }
    } catch (error) {
        grid.innerHTML = '<p style="text-align:center;color:#dc3545;">Erreur de chargement</p>';
        console.error(error);
    }
}

function toggleLibrarySelection(item) {
    const existingIndex = selectedLibraryMedia.findIndex(m => m.id === item.id);
    
    if (existingIndex >= 0) {
        selectedLibraryMedia.splice(existingIndex, 1);
    } else {
        selectedLibraryMedia.push(item);
    }
    
    // Update the grid visually
    const gridItem = document.querySelector(`.library-item[data-id="${item.id}"]`);
    if (gridItem) {
        gridItem.classList.toggle('selected');
        const checkMark = gridItem.querySelector('.check-mark');
        if (existingIndex >= 0) {
            if (checkMark) checkMark.remove();
        } else {
            const mark = document.createElement('span');
            mark.className = 'check-mark';
            mark.textContent = '‚úì';
            gridItem.appendChild(mark);
        }
    }
    
    updateLibrarySelectionCount();
}

function updateLibrarySelectionCount() {
    const countEl = document.getElementById('librarySelectionCount');
    if (countEl) {
        countEl.textContent = selectedLibraryMedia.length > 0 
            ? `${selectedLibraryMedia.length} fichier(s) s√©lectionn√©(s)` 
            : '';
    }
}

function confirmLibrarySelection() {
    updateLibraryMediaPreview();
    closeMediaLibraryModal();
}

function updateLibraryMediaPreview() {
    const preview = document.getElementById('libraryMediaPreview');
    preview.innerHTML = '';
    
    selectedLibraryMedia.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'library-preview-item';
        
        if (item.type === 'image') {
            div.innerHTML = `
                <img src="${item.url}" alt="${item.name}">
                <button class="remove-btn" onclick="removeLibraryMedia(${index})">&times;</button>
            `;
        } else {
            div.innerHTML = `
                <video src="${item.url}" muted></video>
                <span class="video-badge">VIDEO</span>
                <button class="remove-btn" onclick="removeLibraryMedia(${index})">&times;</button>
            `;
        }
        preview.appendChild(div);
    });
}

function removeLibraryMedia(index) {
    selectedLibraryMedia.splice(index, 1);
    updateLibraryMediaPreview();
}

// ========== TEMPLATE FUNCTIONS ==========

// Load templates list on page load
async function loadTemplatesList() {
    const select = document.getElementById('templateSelect');
    if (!select) return;
    
    try {
        const response = await fetch('/api/templates');
        const data = await response.json();
        
        // Clear existing options except first
        select.innerHTML = '<option value="">üìÅ Charger un Script Pr√™t...</option>';
        
        if (data.success && data.templates && data.templates.length > 0) {
            data.templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = `üìù ${template.name}${template.category ? ' (' + template.category + ')' : ''}`;
                option.dataset.content = template.content || '';
                select.appendChild(option);
            });
        } else {
            const option = document.createElement('option');
            option.value = '';
            option.disabled = true;
            option.textContent = '-- Aucun script sauvegard√© --';
            select.appendChild(option);
        }
    } catch (error) {
        console.error('Failed to load templates:', error);
    }
}

// Load selected template into the form
async function loadSelectedTemplate() {
    const select = document.getElementById('templateSelect');
    const templateId = select.value;
    
    if (!templateId) return;
    
    try {
        const response = await fetch('/api/templates');
        const data = await response.json();
        
        if (data.success && data.templates) {
            const template = data.templates.find(t => t.id == templateId);
            if (template) {
                // Fill in the content
                document.getElementById('postContent').value = template.content || '';
                
                // Update character count
                document.getElementById('charCount').textContent = (template.content || '').length;
                
                // Show success toast
                showToast('‚úì Script charg√©: ' + template.name, 'success');
                
                // Reset select
                setTimeout(() => { select.value = ''; }, 100);
            }
        }
    } catch (error) {
        console.error('Failed to load template:', error);
        showToast('Erreur lors du chargement', 'error');
    }
}

// Save current content as a new template
async function saveAsTemplate() {
    const content = document.getElementById('postContent').value.trim();
    
    if (!content) {
        showToast('Veuillez d\'abord √©crire du contenu', 'error');
        return;
    }
    
    // Prompt for template name
    const name = prompt('Nom du script:', 'Mon Script ' + new Date().toLocaleDateString('fr-FR'));
    
    if (!name) return; // User cancelled
    
    try {
        const response = await fetch('/api/templates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': window.csrfToken || ''
            },
            body: JSON.stringify({
                name: name,
                content: content,
                category: 'saved'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('‚úì Script sauvegard√©: ' + name, 'success');
            // Reload templates list
            loadTemplatesList();
        } else {
            showToast('Erreur: ' + (data.error || '√âchec de la sauvegarde'), 'error');
        }
    } catch (error) {
        console.error('Failed to save template:', error);
        showToast('Erreur lors de la sauvegarde', 'error');
    }
}

// Simple toast notification
function showToast(message, type = 'info') {
    // Remove existing toast
    const existing = document.querySelector('.toast-notification');
    if (existing) existing.remove();
    
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 16px 24px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 10000;
        font-weight: 500;
        animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Load templates on page load
loadTemplatesList();

loadGroups();
</script>
{% endblock %}
